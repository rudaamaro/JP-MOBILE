<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Flashcards (Romaji ↔ PT)</title>
  <style>
    :root{
      color-scheme: dark;
      --bg:#0b0f14; --card:#111827; --muted:#9fb3c8; --text:#e7eef7;
      --accent:#43b6ff; --accent2:#7cffad; --danger:#ff6b6b; --warn:#ffd166; --stroke:#223047;
      --radius:16px; --maxw:860px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:var(--bg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;}
    body{min-height:100svh; -webkit-text-size-adjust:100%;}
    .app{ min-height:100svh; display:flex; flex-direction:column; align-items:center;
      padding: env(safe-area-inset-top) 12px calc(12px + env(safe-area-inset-bottom)) 12px; gap:12px; }
    header, .card, .tabs, .section { width:100%; max-width:var(--maxw); }
    header{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 4px; }
    .brand{font-weight:800; color:var(--text); font-size:18px}
    .progress{height:8px; background:#0f1422; border-radius:999px; overflow:hidden; flex:1; margin:0 10px; border:1px solid rgba(255,255,255,.06)}
    .progress > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent2))}
    .streak{color:var(--muted); font-weight:600; font-size:12px; white-space:nowrap}
    .modeToggle{ display:inline-flex; align-items:center; gap:6px; background:#0f1422; border:1px solid rgba(255,255,255,.08);
      border-radius:999px; padding:6px 10px; color:var(--text); font-weight:800 }
    .modeToggle small{color:var(--muted); font-weight:700}
    .pillBtn{ height:28px; padding:0 10px; border-radius:999px; border:1px solid rgba(255,255,255,.1);
      background:var(--accent); color:#05121d; font-weight:800 }
    .tabs{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
    .tab{ padding:10px 12px; text-align:center; background:#0f1422; color:var(--text);
      border-radius:12px; border:1px solid rgba(255,255,255,.06); font-weight:700; }
    .tab.active{ background:var(--accent); color:#05121d; border-color:rgba(67,182,255,.5) }
    .card{ background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius);
      padding:18px; display:flex; flex-direction:column; gap:16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between }
    .seg{ display:inline-flex; padding:4px; gap:4px; border-radius:14px; background:#0f1422; border:1px solid rgba(255,255,255,.06) }
    .seg input{display:none}
    .seg label{ padding:8px 12px; border-radius:10px; font-weight:800; color:var(--text); cursor:pointer; }
    .seg input:checked + label{ background:var(--accent); color:#05121d; }
    .prompt{ text-align:center; color:var(--muted); font-weight:700; letter-spacing:.3px; }
    .question{ text-align:center; color:var(--text); font-weight:900; font-size: clamp(20px, 6.5vw, 40px); word-break:break-word; }
    .qRow{ display:flex; align-items:center; justify-content:center; gap:8px; flex-wrap:wrap }
    .audioBtn{ height:38px; min-width:38px; padding:0 12px; border-radius:12px; background:#0f1422; color:var(--text);
      border:1px solid rgba(255,255,255,.08); font-weight:800 }
    .inputRow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center; }
    input.answer{
      flex:1 1 320px; max-width:560px; height:52px; background:#0f1422; border:2px solid var(--stroke);
      border-radius:14px; padding:0 14px; color:var(--text); font-size:18px; font-weight:700; outline:none;
    }
    input.answer:focus{ border-color:var(--accent) }
    select.select{ height:44px; padding:0 12px; border-radius:12px; background:#0f1422; color:var(--text);
      border:2px solid var(--stroke); font-weight:700 }
    .btn{ height:52px; padding:0 16px; border-radius:14px; font-weight:800; border:1px solid rgba(255,255,255,.08);
      background:var(--accent); color:#05121d; }
    .btn.secondary{ background:#1f2937; color:#e7eef7 }
    .btn.warn{ background:var(--warn); color:#2a1b00 }
    .btn.good{ background:var(--accent2); color:#04210f }
    .btn.danger{ background:var(--danger); color:#2a0000 }
    .center{display:flex; justify-content:center; gap:10px; flex-wrap:wrap}
    .helper{ color:var(--muted); text-align:center; font-size:13px }
    .section{display:none}
    .section.active{display:block}
    textarea.bulk{
      width:100%; min-height:200px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background:#0f1422; color:#e7eef7; font: 500 14px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    table.list{width:100%; border-collapse:separate; border-spacing:0 6px}
    table.list th, table.list td{padding:10px 12px; text-align:left; font-size:14px}
    table.list th{color:var(--muted); font-weight:800}
    table.list tr{background:#0f1422; border:1px solid rgba(255,255,255,.08)}
    table.list tr td:first-child{border-radius:12px 0 0 12px}
    table.list tr td:last-child{border-radius:0 12px 12px 0}
    .kudos{ color:var(--muted); text-align:center; font-size:12px; padding:8px }
    .msg{
      position:fixed; left:12px; right:12px; bottom:calc(12px + env(safe-area-inset-bottom));
      background:rgba(0,0,0,.55); color:#e7eef7; border:1px solid rgba(255,255,255,.15);
      border-radius:12px; padding:10px 12px; font-weight:700; text-align:center;
      max-width:var(--maxw); margin:0 auto;
    }
    button, input, textarea, select { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="brand">Flashcards — Romaji ↔ PT</div>
      <div class="progress"><i id="progBar" style="width:0%"></i></div>
      <div class="modeToggle">
        <small>Modo</small>
        <button id="toggleMode" class="pillBtn" title="Alternar Revisão/Treino">Revisão</button>
      </div>
      <div class="streak" id="streak">Streak: 0</div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="study">Estudar</button>
      <button class="tab" data-tab="add">Adicionar</button>
      <button class="tab" data-tab="list">Lista</button>
    </div>

    <!-- STUDY -->
    <section class="section active" id="study">
      <div class="card">
        <div class="row">
          <div class="seg" aria-label="Direção">
            <input id="d1" type="radio" name="dir" value="PT2ROMAJI" checked><label for="d1">PT → Romaji</label>
            <input id="d2" type="radio" name="dir" value="ROMAJI2PT"><label for="d2">Romaji → PT</label>
          </div>
          <div class="row" style="gap:6px">
            <label class="helper" for="catFilter">Categoria:&nbsp;</label>
            <select id="catFilter" class="select"><option value="todas">todas</option></select>
            <span class="helper">Meta diária: <b id="goal">20</b></span>
          </div>
        </div>

        <div class="prompt" id="promptLbl">Tradução (PT-BR)</div>
        <div class="qRow">
          <button title="Ouvir Romaji" class="audioBtn" id="speakRomaji">🔊 JP</button>
          <div class="question" id="qMain">—</div>
          <button title="Ouvir Português" class="audioBtn" id="speakPT">🔊 PT</button>
        </div>
        <div class="center helper" id="helperLbl">Digite o <b>romaji</b> e pressione Verificar</div>

        <div class="inputRow">
          <input id="answer" class="answer" placeholder="ex.: konnichiwa"
            autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
            inputmode="latin" enterkeyhint="done">
          <button class="btn" id="btnCheck">Verificar</button>
        </div>

        <div class="center" id="afterCheck" style="display:none">
          <button class="btn danger" id="bHard">Difícil (1)</button>
          <button class="btn warn"   id="bMed">Médio (2)</button>
          <button class="btn good"   id="bEasy">Fácil (3)</button>
        </div>

        <div class="center helper" id="accepted" style="display:none"></div>
      </div>
    </section>

    <!-- ADD -->
    <section class="section" id="add">
      <div class="card">
        <div class="prompt">Adicionar novo card</div>
        <div class="inputRow">
          <input id="inRomaji" class="answer" placeholder="romaji (ex.: arigatou)" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false">
          <input id="inPT" class="answer" placeholder="traduções PT (ex.: obrigado; obrigada)">
          <input id="inCat" class="answer" placeholder="categoria (ex.: saudacao)">
          <button class="btn" id="btnAdd">Adicionar</button>
        </div>
        <div class="helper">Dica: separe sinônimos em PT por <b>;</b></div>
      </div>
      <div class="card">
        <div class="prompt">Importar em massa (colar lista)</div>
        <div class="helper">Formato: <code>romaji ; tradução1 ; tradução2 ; #categoria</code> (categoria opcional, iniciando com <code>#</code>)</div>
        <textarea class="bulk" id="bulk" placeholder="konnichiwa ; olá ; boa tarde ; #saudacao&#10;arigatou ; obrigado ; obrigada ; #saudacao"></textarea>
        <div class="center">
          <button class="btn secondary" id="btnParse">Pré-visualizar</button>
          <button class="btn" id="btnImport">Adicionar tudo</button>
        </div>
        <div id="preview" class="helper"></div>
      </div>
    </section>

    <!-- LIST -->
    <section class="section" id="list">
      <div class="card">
        <div class="prompt">Cartas (toque para remover) • Importar/Exportar JSON</div>
        <div class="center" style="gap:8px">
          <input type="file" id="fileIn" accept=".json" style="display:none">
          <button class="btn secondary" id="btnImportFile">Importar JSON</button>
          <button class="btn secondary" id="btnExport">Exportar JSON</button>
        </div>
        <table class="list" id="table"></table>
      </div>
    </section>

    <div class="kudos">Feito para iOS/Safari • Salva no navegador • Direção PT↔Romaji • Áudio • Filtro por categoria • Modo Revisão/Treino no topo • Carrega <code>anime_romaji.json</code></div>
    <div class="msg" id="msg" style="display:none"></div>
  </div>

  <script>
  // ======= CONFIG =======
  // Se o site estiver no GitHub Pages com anime_romaji.json na raiz, este caminho funciona:
  const DATA_URL = './anime_romaji.json';

  // ======= STORAGE & HELPERS =======
  const LS_DECK = 'romajiDeck_v5';
  const LS_STATS = 'romajiStats_v3';

  const defaultDeck = [
    ["konnichiwa","olá; boa tarde","geral"],
    ["ohayou","bom dia","geral"],
    ["konbanwa","boa noite (cumprimento)","geral"]
  ];

  const toISO = (d = new Date()) => {
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  };
  const addDays = (iso,n)=>{const d=new Date(iso+'T00:00:00'); d.setDate(d.getDate()+n); return toISO(d);};
  const normBasic = s => (s||'').toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/\([^)]*\)/g,' ')
      .replace(/[\p{P}\p{S}]/gu,' ')
      .replace(/\s+/g,' ').trim();
  const parsePT = pt => (pt||'').split(/[|;,\n]/).map(normBasic).filter(Boolean);

  function seed(list){
    const today = toISO();
    return list.map(([romaji,pt,cat='geral'], i)=>({
      id:String(Date.now()+i),
      romaji:String(romaji||'').toLowerCase().trim(),
      pt:String(pt||'').toLowerCase().trim(),
      cat:String(cat||'geral').toLowerCase().trim(),
      due: today, ef:2.5, ivl:0, reps:0, ok:0, err:0
    }));
  }
  function migrate(arr){
    const today = toISO();
    return arr.map(c=>({
      id: c.id || String(Date.now()+Math.random()),
      romaji: String(c.romaji||'').toLowerCase().trim(),
      pt: String(c.pt||'').toLowerCase().trim(),
      cat: String(c.cat||'geral').toLowerCase().trim(),
      due: c.due || today, ef: typeof c.ef==='number'?c.ef:2.5,
      ivl: c.ivl||0, reps: c.reps||0, ok:c.ok||0, err:c.err||0
    }));
  }
  function loadDeckLS(){
    try{ const raw = JSON.parse(localStorage.getItem(LS_DECK)); if(Array.isArray(raw)) return migrate(raw); }catch(e){}
    return null;
  }
  function saveDeck(){ localStorage.setItem(LS_DECK, JSON.stringify(deck)); }

  // ======= STATS =======
  const defaultStats = {streak:0,lastStudy:null,studiedToday:0,dailyGoal:20};
  function loadStats(){ try{ return Object.assign({}, defaultStats, JSON.parse(localStorage.getItem(LS_STATS)||'{}')); }catch(e){ return {...defaultStats};} }
  function saveStats(){ localStorage.setItem(LS_STATS, JSON.stringify(stats)); }
  function rollover(){
    const t = toISO();
    if(!stats.lastStudy){ stats.lastStudy=t; stats.studiedToday=0; saveStats(); return; }
    if(stats.lastStudy!==t){
      const y=new Date(stats.lastStudy+'T00:00:00'), d=new Date(t+'T00:00:00');
      stats.streak = Math.round((d-y)/86400000)===1 ? (stats.streak+1) : 1;
      stats.studiedToday=0; stats.lastStudy=t; saveStats();
    }
  }

  // ======= SRS =======
  function schedule(card,grade){
    const minEF=1.3;
    if(grade===0){ card.err++; card.reps=0; card.ef=Math.max(minEF,(card.ef||2.5)-0.2); card.ivl=1; card.due=addDays(toISO(),1); return; }
    card.ok++;
    if(card.reps===0){ card.ivl = (grade===2)?3:1; }
    else { const mult = grade===2?(card.ef*1.3):card.ef; card.ivl = Math.max(1, Math.round(card.ivl*mult)); }
    card.ef = Math.max(minEF, (card.ef||2.5) + (grade===2?+0.10:-0.05));
    card.reps++; card.due = addDays(toISO(), card.ivl);
  }

// ======= ÁUDIO (iOS fix: romaji -> hiragana) =======
let voices = [];
function loadVoices(){ voices = window.speechSynthesis ? speechSynthesis.getVoices() : []; }
if ('speechSynthesis' in window){
  speechSynthesis.onvoiceschanged = loadVoices; loadVoices();
}

// conversão romaji -> hiragana (básico, cobre 99% do seu deck)
function romajiToHiragana(input){
  if(!input) return "";
  let s = input.toLowerCase().trim();

  // normaliza espaços/pontuação
  s = s.replace(/[^a-zA-Z0-9 ?!.,-]/g, ' ')
       .replace(/\s+/g,' ')
       .trim();

  // casos especiais comuns
  s = s.replace(/nn/g, 'n');    // trata "nn" como ん
  // alongamentos simples (não perfeito, mas ajuda naturalidade)
  // deixa "ou" e "uu" como estão (おう/うう saem automaticamente pelo parser de mora)

  // tabelas
  const youon = {
    'kya':'きゃ','kyu':'きゅ','kyo':'きょ',
    'gya':'ぎゃ','gyu':'ぎゅ','gyo':'ぎょ',
    'sha':'しゃ','shu':'しゅ','sho':'しょ',
    'ja':'じゃ','ju':'じゅ','jo':'じょ',
    'jya':'じゃ','jyu':'じゅ','jyo':'じょ',
    'cha':'ちゃ','chu':'ちゅ','cho':'ちょ',
    'nya':'にゃ','nyu':'にゅ','nyo':'にょ',
    'hya':'ひゃ','hyu':'ひゅ','hyo':'ひょ',
    'bya':'びゃ','byu':'びゅ','byo':'びょ',
    'pya':'ぴゃ','pyu':'ぴゅ','pyo':'ぴょ',
    'mya':'みゃ','myu':'みゅ','myo':'みょ',
    'rya':'りゃ','ryu':'りゅ','ryo':'りょ'
  };
  const map = {
    'a':'あ','i':'い','u':'う','e':'え','o':'お',
    'ka':'か','ki':'き','ku':'く','ke':'け','ko':'こ',
    'ga':'が','gi':'ぎ','gu':'ぐ','ge':'げ','go':'ご',
    'sa':'さ','shi':'し','si':'し','su':'す','se':'せ','so':'そ',
    'za':'ざ','ji':'じ','zi':'じ','zu':'ず','ze':'ぜ','zo':'ぞ',
    'ta':'た','chi':'ち','ti':'ち','tsu':'つ','tu':'つ','te':'て','to':'と',
    'da':'だ','di':'ぢ','du':'づ','de':'で','do':'ど',
    'na':'な','ni':'に','nu':'ぬ','ne':'ね','no':'の',
    'ha':'は','hi':'ひ','fu':'ふ','hu':'ふ','he':'へ','ho':'ほ',
    'ba':'ば','bi':'び','bu':'ぶ','be':'べ','bo':'ぼ',
    'pa':'ぱ','pi':'ぴ','pu':'ぷ','pe':'ぺ','po':'ぽ',
    'ma':'ま','mi':'み','mu':'む','me':'め','mo':'も',
    'ya':'や','yu':'ゆ','yo':'よ',
    'ra':'ら','ri':'り','ru':'る','re':'れ','ro':'ろ',
    'wa':'わ','wo':'を',
    // palavras comuns que vêm “ocidentalizadas” (mantém naturalidade)
    'che':'ちぇ','she':'しぇ','je':'じぇ'
  };

  // tokenização greedy
  let out = '';
  let i = 0;
  const isVowel = c => /[aeiou]/.test(c);
  const isConsonant = c => /[bcdfghjklmnpqrstvwxyz]/.test(c);

  while(i < s.length){
    // espaços e pontuação leves
    if(/\s/.test(s[i])){ out += ' '; i++; continue; }
    if(/[?!.,-]/.test(s[i])){ out += s[i]; i++; continue; }

    // sokuon (pequeno っ) para consoante duplicada (exceto 'n')
    if(i+1 < s.length && s[i] === s[i+1] && isConsonant(s[i]) && s[i] !== 'n'){
      out += 'っ'; i++; continue;
    }

    // ん antes de consoante ou fim
    if(s[i] === 'n'){
      const nxt = s[i+1] || '';
      if(!nxt || (!isVowel(nxt) && nxt !== 'y')){
        out += 'ん'; i++; continue;
      }
    }

    // youon (3 letras)
    const tri = s.slice(i, i+3);
    if(youon[tri]){ out += youon[tri]; i += 3; continue; }

    // kana “normais” (3, 2, 1)
    const triMap = map[tri];
    if(triMap){ out += triMap; i += 3; continue; }
    const bi = s.slice(i, i+2);
    const biMap = map[bi];
    if(biMap){ out += biMap; i += 2; continue; }
    const one = s[i];
    const oneMap = map[one];
    if(oneMap){ out += oneMap; i += 1; continue; }

    // fallback: mantém letra (evita travar)
    out += s[i];
    i++;
  }

  // “ou” após お vira おう naturalmente por map + sequência; apenas compacta múltiplos espaços
  return out.replace(/\s{2,}/g,' ').trim();
}

// fala japonês usando ja-JP e texto em hiragana
function speakJP(romaji){
  if(!('speechSynthesis' in window)) return;
  const kana = romajiToHiragana(romaji);
  if(!kana) return;
  const u = new SpeechSynthesisUtterance(kana);
  // tenta voz japonesa; no iOS às vezes só funciona se NÃO setar voice, apenas lang
  const pick = (pref)=> voices.find(v=>v.lang && v.lang.toLowerCase().startsWith(pref));
  const v = pick('ja-jp') || pick('ja');
  if(v) u.voice = v;
  u.lang = 'ja-JP';
  u.rate = 0.95;
  u.pitch = 1.0;
  // “desengasga” no iOS se havia outra fala em andamento
  try{ speechSynthesis.cancel(); }catch(_){}
  speechSynthesis.speak(u);
}

// fala PT (sem mudanças)
function speakPT(texto){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(texto);
  const pick = (pref)=> voices.find(v=>v.lang && v.lang.toLowerCase().startsWith(pref));
  const v = pick('pt-br') || pick('pt-pt') || voices[0];
  if(v) u.voice = v;
  u.lang = v?.lang || 'pt-BR';
  u.rate = 1.0; u.pitch = 1.0;
  try{ speechSynthesis.cancel(); }catch(_){}
  speechSynthesis.speak(u);
}

// ——— substitua os listeners antigos por estes:
document.getElementById('speakRomaji')?.addEventListener('click', ()=>{
  const c = State.current; if(!c) return;
  speakJP(c.romaji);
});
document.getElementById('speakPT')?.addEventListener('click', ()=>{
  const c = State.current; if(!c) return;
  let txt='';
  if(State.direction==='PT2ROMAJI'){
    txt = document.getElementById('qMain').textContent || parsePT(c.pt)[0] || c.pt;
  } else {
    txt = (parsePT(c.pt)[0] || c.pt);
  }
  speakPT(txt);
});

  // ======= STATE =======
  let deck = loadDeckLS();
  let stats = loadStats();
  rollover();

  const State = {
    modeTab: 'study',
    direction: 'PT2ROMAJI',   // PT→Romaji | ROMAJI→PT
    studyMode: 'REVIEW',      // REVIEW | TRAIN
    catFilter: 'todas',
    current: null,
    trainPool: [],
    trainWrong: []
  };

  // ======= UI =======
  const el = s => document.querySelector(s);
  const els = s => [...document.querySelectorAll(s)];
  const toastEl = el('#msg');
  function toast(t, ms=1400){ toastEl.textContent=t; toastEl.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>{toastEl.style.display='none'}, ms); }

  // Top toggle (Revisão/Treino)
  function updateModeToggle(){
    el('#toggleMode').textContent = (State.studyMode==='REVIEW' ? 'Revisão' : 'Treino ∞');
  }
  el('#toggleMode').addEventListener('click', ()=>{
    State.studyMode = (State.studyMode==='REVIEW' ? 'TRAIN' : 'REVIEW');
    updateModeToggle(); buildTrainPool(); pickNext();
  });

  // Tabs
  els('.tab').forEach(b=>{
    b.addEventListener('click', ()=>{
      els('.tab').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const tab = b.dataset.tab;
      els('.section').forEach(s=>s.classList.remove('active'));
      el('#'+tab).classList.add('active');
      State.modeTab = tab;
      if(tab==='study') pickNext();
      if(tab==='list') { renderTable(); refreshCategoriesUI(); }
    });
  });

  // Direção
  els('input[name="dir"]').forEach(r=>{
    r.addEventListener('change', ()=>{
      State.direction = r.value;
      applyDirectionLabels();
      if(State.modeTab==='study') pickNext();
    });
  });

  // Categoria
  el('#catFilter').addEventListener('change', ()=>{
    State.catFilter = el('#catFilter').value;
    buildTrainPool();
    pickNext();
  });

  function applyDirectionLabels(){
    if(State.direction==='PT2ROMAJI'){
      el('#promptLbl').textContent = 'Tradução (PT-BR)';
      el('#helperLbl').innerHTML = 'Digite o <b>romaji</b> e pressione Verificar';
      el('#answer').placeholder = 'ex.: konnichiwa';
    } else {
      el('#promptLbl').textContent = 'Romaji';
      el('#helperLbl').innerHTML = 'Digite uma tradução em <b>PT-BR</b> que sirva';
      el('#answer').placeholder = 'ex.: olá';
    }
  }
  function renderHeader(){
    const pct = Math.max(0, Math.min(1, (stats.studiedToday||0)/(stats.dailyGoal||20)));
    el('#progBar').style.width = (pct*100).toFixed(0)+'%';
    el('#streak').textContent = `Streak: ${stats.streak||0}`;
    el('#goal').textContent = String(stats.dailyGoal||20);
    updateModeToggle();
  }

  // ======= CATEGORIAS =======
  function refreshCategoriesUI(){
    const sel = el('#catFilter');
    const cats = new Set(deck.map(c=>c.cat||'geral')); cats.add('todas');
    const cur = sel.value;
    sel.innerHTML = '';
    [...cats].sort().forEach(c=>{
      const opt = document.createElement('option'); opt.value=c; opt.textContent=c;
      sel.appendChild(opt);
    });
    sel.value = cats.has(cur)? cur : 'todas';
  }
  function filteredByCategory(list){
    if(State.catFilter==='todas') return list;
    return list.filter(c=> (c.cat||'geral')===State.catFilter);
  }

  // ======= POOL TREINO ∞ =======
  function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} }
  function buildTrainPool(){
    const base = filteredByCategory(deck).slice();
    shuffle(base);
    State.trainPool = base;
    State.trainWrong = [];
  }

  // ======= ESTUDO =======
  function dueCards(){ const t=toISO(); return deck.filter(c => (c.due||t) <= t); }
  function pickFromReview(){
    const arr = filteredByCategory(dueCards());
    return arr.length ? arr[Math.floor(Math.random()*arr.length)] : null;
  }
  function pickFromTrain(){
    const useWrong = State.trainWrong.length && Math.random() < 0.6;
    if(useWrong) return State.trainWrong[Math.floor(Math.random()*State.trainWrong.length)];
    if(!State.trainPool.length) buildTrainPool();
    return State.trainPool[Math.floor(Math.random()*State.trainPool.length)] || null;
  }
  function pickNext(){
    State.current = (State.studyMode==='REVIEW') ? pickFromReview() : pickFromTrain();
    el('#answer').value='';
    if(State.current){
      if(State.direction==='PT2ROMAJI'){
        const opts = parsePT(State.current.pt);
        el('#qMain').textContent = opts.length? opts[Math.floor(Math.random()*opts.length)] : State.current.pt;
      }else{
        el('#qMain').textContent = State.current.romaji;
      }
      el('#accepted').style.display='none';
      el('#afterCheck').style.display='none';
    } else {
      el('#qMain').textContent = (State.studyMode==='REVIEW')
        ? 'Sem cartas “devidas” nesta categoria. Use Treino ∞.'
        : 'Sem cartas nesta categoria. Adicione algumas em “Adicionar”.';
    }
    renderHeader();
  }

  function checkAnswer(){
    if(!State.current) return;
    const user = normBasic(el('#answer').value);
    let ok=false, feedback='';
    if(State.direction==='PT2ROMAJI'){
      ok = !!user && (user === normBasic(State.current.romaji));
      feedback = `Correto: <b>${State.current.romaji}</b> • <small>Traduções: ${parsePT(State.current.pt).join(' / ')}</small>`;
    }else{
      const acc = new Set(parsePT(State.current.pt));
      ok = !!user && acc.has(user);
      feedback = `Romaji: <b>${State.current.romaji}</b> • <small>Traduções aceitas: ${[...acc].join(' / ')}</small>`;
    }
    el('#accepted').innerHTML = feedback; el('#accepted').style.display='block'; el('#afterCheck').style.display='flex';
    toast(ok? '✔ Correto! Agora marque a dificuldade.' : '✘ Quase! Confirme e marque a dificuldade.');
    el('#afterCheck').dataset.ok = ok ? '1' : '0';
    if(State.studyMode==='TRAIN'){
      const iWrong = State.trainWrong.findIndex(c=>c.id===State.current.id);
      if(!ok && iWrong===-1) State.trainWrong.push(State.current);
      if(ok && iWrong!==-1) State.trainWrong.splice(iWrong,1);
    }
  }

  function grade(level){
    if(!State.current) return;
    const wasOk = el('#afterCheck').dataset.ok === '1';
    if(State.studyMode==='REVIEW'){
      if(wasOk) State.current.ok++; else State.current.err++;
      schedule(State.current, level);
      saveDeck();
      stats.studiedToday=(stats.studiedToday||0)+1; stats.lastStudy=toISO(); if(!stats.streak) stats.streak=1; saveStats();
    } else {
      if(wasOk) State.current.ok++; else State.current.err++;
      saveDeck();
    }
    pickNext();
  }

  // Áudio
  el('#speakRomaji').addEventListener('click', ()=>{
    const c = State.current; if(!c) return; speak(c.romaji, 'ja-JP');
  });
  el('#speakPT').addEventListener('click', ()=>{
    const c = State.current; if(!c) return;
    let txt=''; if(State.direction==='PT2ROMAJI'){ txt = el('#qMain').textContent || parsePT(c.pt)[0] || c.pt; }
    else { txt = (parsePT(c.pt)[0] || c.pt); }
    speak(txt, 'pt-BR');
  });

  // Ações
  el('#btnCheck').addEventListener('click', checkAnswer);
  el('#answer').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); checkAnswer(); }});
  el('#bHard').addEventListener('click', ()=>grade(0));
  el('#bMed').addEventListener('click',  ()=>grade(1));
  el('#bEasy').addEventListener('click', ()=>grade(2));

  // ======= ADD / BULK =======
  function parseBulk(text){
    const out=[]; (text||'').split(/\r?\n/).forEach(line=>{
      line=line.trim(); if(!line) return;
      const parts=line.split(/\t|\s*;\s*/).map(s=>s.trim()).filter(Boolean);
      if(parts.length<2) return;
      let cat=''; if(parts[parts.length-1].startsWith('#')) cat = parts.pop().slice(1);
      const [romaji, ...rest] = parts; out.push({romaji, pt: rest.join(';'), cat});
    }); return out;
  }
  function addCard(r,p,cat){
    const rom = normBasic(r), pt = normBasic(p); const c = String(cat||'geral').toLowerCase().trim() || 'geral';
    if(!rom || !pt) return false;
    if(deck.some(x=>normBasic(x.romaji)===rom)) return false;
    deck.push({id:String(Date.now()+Math.random()*9999), romaji:rom, pt:pt, cat:c, due:toISO(), ef:2.5, ivl:0, reps:0, ok:0, err:0});
    return true;
  }
  el('#btnAdd').addEventListener('click', ()=>{
    const ok = addCard(el('#inRomaji').value, el('#inPT').value, el('#inCat').value);
    if(!ok){ toast('Preencha corretamente ou evite duplicar romaji'); return; }
    saveDeck(); el('#inRomaji').value=''; el('#inPT').value=''; el('#inCat').value='';
    refreshCategoriesUI(); buildTrainPool(); toast('Card adicionado!');
  });
  el('#btnParse').addEventListener('click', ()=>{
    const arr = parseBulk(el('#bulk').value);
    el('#preview').innerHTML = arr.length ? `Pronto para importar: <b>${arr.length}</b> linha(s).` : 'Nada válido encontrado.';
  });
  el('#btnImport').addEventListener('click', ()=>{
    const arr = parseBulk(el('#bulk').value); if(!arr.length){ toast('Nada válido para importar'); return; }
    let added=0, skipped=0; for(const it of arr){ if(addCard(it.romaji, it.pt, it.cat)) added++; else skipped++; }
    saveDeck(); refreshCategoriesUI(); buildTrainPool();
    toast(`Importados: ${added}. Ignorados: ${skipped}.`); el('#bulk').value=''; el('#preview').textContent='';
  });

  // ======= LISTA + IMPORT/EXPORT =======
  function renderTable(){
    const t = el('#table'); t.innerHTML='';
    const head = `<tr><th>#</th><th>Romaji</th><th>Traduções</th><th>Cat</th><th>Próx.</th><th>✓</th><th>✗</th></tr>`;
    t.insertAdjacentHTML('beforeend', head);
    deck.slice().sort((a,b)=> (a.romaji>b.romaji?1:-1)).forEach((c,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${c.romaji}</td><td>${c.pt}</td><td>${c.cat||'geral'}</td><td>${c.due||''}</td><td>${c.ok||0}</td><td>${c.err||0}</td>`;
      tr.addEventListener('click', ()=>{ deck = deck.filter(x=>x.id!==c.id); saveDeck(); renderTable(); refreshCategoriesUI(); buildTrainPool(); toast('Removido.'); });
      t.appendChild(tr);
    });
  }
  el('#btnImportFile').addEventListener('click', ()=> el('#fileIn').click());
  el('#fileIn').addEventListener('change', async (ev)=>{
    const f = ev.target.files?.[0]; if(!f) return;
    try{
      const text = await f.text(); const data = JSON.parse(text);
      if(!Array.isArray(data)) throw new Error('JSON precisa ser array [{romaji,pt,cat?}]');
      let added=0; const have = new Set(deck.map(c=>normBasic(c.romaji)));
      data.forEach((obj,i)=>{
        const r = normBasic(obj.romaji), p = normBasic(obj.pt), c = String(obj.cat||'geral').toLowerCase();
        if(!r || !p || have.has(r)) return;
        deck.push({id:String(Date.now()+i), romaji:r, pt:p, cat:c, due:toISO(), ef:2.5, ivl:0, reps:0, ok:0, err:0});
        have.add(r); added++;
      });
      saveDeck(); renderTable(); refreshCategoriesUI(); buildTrainPool();
      toast(`Importados do arquivo: ${added}.`);
    }catch(e){ console.error(e); toast('Falha ao importar JSON'); }
  });
  el('#btnExport').addEventListener('click', ()=>{
    const data = deck.map(({romaji,pt,cat})=>({romaji,pt,cat}));
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'anime_romaji.json'; a.click(); URL.revokeObjectURL(a.href);
  });

  // ======= CARREGAR DO SEU JSON (GitHub Pages) =======
  async function hydrateFromJson(){
    try{
      const res = await fetch(DATA_URL, {cache:'no-store'});
      if(res.ok){
        const data = await res.json();
        if(Array.isArray(data)){
          let added=0, have = new Set(deck.map(c=>normBasic(c.romaji)));
          data.forEach((obj,i)=>{
            const r = normBasic(obj.romaji), p = Array.isArray(obj.pt)? obj.pt.join(';') : String(obj.pt||'');
            const c = String(obj.cat||'geral').toLowerCase();
            if(!r || !p || have.has(r)) return;
            deck.push({id:String(Date.now()+i), romaji:r, pt:normBasic(p), cat:c, due:toISO(), ef:2.5, ivl:0, reps:0, ok:0, err:0});
            have.add(r); added++;
          });
          if(added) saveDeck();
        }
      }
    }catch(e){ /* em file:// pode falhar; ignore */ }
  }

  // ======= INIT =======
  (async function init(){
    if(!deck) deck = seed(defaultDeck);
    await hydrateFromJson();      // lê o seu anime_romaji.json hospedado
    applyDirectionLabels();
    refreshCategoriesUI();
    buildTrainPool();
    renderHeader();
    pickNext();
  })();
  </script>
</body>
</html>
