<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Flashcards (Romaji ‚Üî PT)</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#0b0f14; --card:#111827; --muted:#9fb3c8; --text:#e7eef7;
    --accent:#43b6ff; --accent2:#7cffad; --danger:#ff6b6b; --warn:#ffd166; --stroke:#223047;
    --radius:16px; --maxw:860px;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
  body{min-height:100svh; -webkit-text-size-adjust:100%}
  .app{min-height:100svh; display:flex; flex-direction:column; align-items:center; gap:12px;
    padding:env(safe-area-inset-top) 12px calc(12px + env(safe-area-inset-bottom)) 12px}
  header,.card,.tabs,.section{width:100%; max-width:var(--maxw)}
  header{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 4px}
  .brand{font-weight:800; color:var(--text); font-size:18px}

  /* Tabs */
  .tabs{display:grid; grid-template-columns:repeat(4,1fr); gap:8px}
  .tab{padding:10px 12px; text-align:center; background:#0f1422; color:var(--text);
    border-radius:12px; border:1px solid rgba(255,255,255,.06); font-weight:700}
  .tab.active{background:var(--accent); color:#05121d; border-color:rgba(67,182,255,.5)}

  /* Cards e UI */
  .card{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius);
    padding:18px; display:flex; flex-direction:column; gap:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between}
  .seg{display:inline-flex; padding:4px; gap:4px; border-radius:14px; background:#0f1422; border:1px solid rgba(255,255,255,.06)}
  .seg input{display:none}
  .seg label{padding:8px 12px; border-radius:10px; font-weight:800; color:var(--text); cursor:pointer}
  .seg input:checked + label{background:var(--accent); color:#05121d}
  .prompt{text-align:center; color:var(--muted); font-weight:700; letter-spacing:.3px}
  .question{text-align:center; color:var(--text); font-weight:900; font-size:clamp(20px,6.5vw,40px); word-break:break-word}
  .qRow{display:flex; align-items:center; justify-content:center; gap:8px; flex-wrap:wrap}
  .audioBtn{height:38px; min-width:38px; padding:0 12px; border-radius:12px; background:#0f1422; color:var(--text);
    border:1px solid rgba(255,255,255,.08); font-weight:800}
  .inputRow{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center}
  input.answer{flex:1 1 320px; max-width:560px; height:52px; background:#0f1422; border:2px solid var(--stroke);
    border-radius:14px; padding:0 14px; color:#e7eef7; font-size:18px; font-weight:700; outline:none}
  input.answer:focus{border-color:var(--accent)}
  input.answer.correct{border-color:var(--accent2); box-shadow:0 0 0 3px rgba(124,255,173,.15)}
  input.answer.wrong{border-color:var(--danger); box-shadow:0 0 0 3px rgba(255,107,107,.15)}
  select.select{height:44px; padding:0 12px; border-radius:12px; background:#0f1422; color:#e7eef7; border:2px solid var(--stroke); font-weight:700}
  .btn{height:52px; padding:0 16px; border-radius:14px; font-weight:800; border:1px solid rgba(255,255,255,.08); background:var(--accent); color:#05121d}
  .btn.secondary{background:#1f2937; color:#e7eef7}
  .center{display:flex; justify-content:center; gap:10px; flex-wrap:wrap}
  .helper{color:var(--muted); text-align:center; font-size:13px}
  .section{display:none}
  .section.active{display:block}
  textarea.bulk{width:100%; min-height:200px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
    background:#0f1422; color:#e7eef7; font:500 14px ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

  /* === LISTA === */
  .tableWrap{max-width:100%; overflow:auto; border-radius:12px}
  table.list{width:100%; border-collapse:separate; border-spacing:0 6px; table-layout:fixed}
  table.list th,table.list td{padding:10px 12px; text-align:left; font-size:14px; word-break:break-word; white-space:normal}
  table.list th{color:var(--muted); font-weight:800}
  table.list tr{background:#0f1422; border:1px solid rgba(255,255,255,.08)}
  table.list tr td:first-child{border-radius:12px 0 0 12px}
  table.list tr td:last-child{border-radius:0 12px 12px 0}
  .col-idx{width:48px}
  .col-romaji{width:28%}
  .col-kana{width:22%}
  .col-pt{width:32%}
  .col-cat{width:12%}
  .col-ok,.col-err{width:48px; text-align:right}

  /* === QUIZ === */
  .choices{display:grid; grid-template-columns:repeat(2,minmax(160px,1fr)); gap:10px}
  .choice{padding:12px; border-radius:12px; border:2px solid var(--stroke); background:#0f1422; color:var(--text); font-weight:800; cursor:pointer}
  .choice:hover{border-color:var(--accent)}
  .choice.correct{border-color:var(--accent2)}
  .choice.wrong{border-color:var(--danger)}
  .quizActions{display:flex; gap:10px; justify-content:center; margin-top:4px}

  /* MOBILE */
  @media (max-width:600px){
    .brand{font-size:16px}
    .tab{padding:8px 10px}
    .card{padding:14px}
    table.list th,table.list td{font-size:12px; padding:8px 10px}
    .col-idx,.col-kana{display:none}
    .col-romaji{width:36%}
    .col-pt{width:42%}
    .col-cat{width:14%}
    .col-ok,.col-err{width:40px}
    .choices{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="brand">Flashcards ‚Äî Romaji ‚Üî PT</div>
    <div class="helper" id="streak">Streak: 0</div>
  </header>

  <div class="tabs">
    <button class="tab active" data-tab="study">Estudar</button>
    <button class="tab" data-tab="quiz">Quiz</button>
    <button class="tab" data-tab="add">+</button>
    <button class="tab" data-tab="list">Lista</button>
  </div>

  <!-- STUDY -->
  <section class="section active" id="study">
    <div class="card">
      <div class="row">
        <div class="seg" aria-label="Dire√ß√£o">
          <input id="d1" type="radio" name="dir" value="PT2ROMAJI" checked><label for="d1">PT ‚Üí Romaji</label>
          <input id="d2" type="radio" name="dir" value="ROMAJI2PT"><label for="d2">Romaji ‚Üí PT</label>
          <input id="d3" type="radio" name="dir" value="HIRA2PT"><label for="d3">Hiragana ‚Üí PT</label>
        </div>
        <div class="row" style="gap:6px">
          <label class="helper" for="catFilter">Categoria:&nbsp;</label>
          <select id="catFilter" class="select"><option value="todas">todas</option></select>
        </div>
      </div>

      <div class="prompt" id="promptLbl">Tradu√ß√£o (PT-BR)</div>
      <div class="qRow">
        <button title="Ouvir Japon√™s" class="audioBtn" id="speakJP">üîä JP</button>
        <div class="question" id="qMain">‚Äî</div>
        <button title="Ouvir Portugu√™s" class="audioBtn" id="speakPT">üîä PT</button>
      </div>
      <div class="center helper" id="helperLbl">Digite o <b>romaji</b> e pressione Verificar</div>

      <div class="inputRow">
        <input id="answer" class="answer" placeholder="ex.: konnichiwa"
          autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
          inputmode="latin" enterkeyhint="done">
        <button class="btn" id="btnCheck">Verificar</button>
        <button class="btn secondary" id="btnSkip">Pular</button>
      </div>

      <div class="center helper" id="accepted" style="display:none"></div>
    </div>
  </section>

  <!-- QUIZ -->
  <section class="section" id="quiz">
    <div class="card">
      <div class="row">
        <div class="seg" aria-label="Dire√ß√£o quiz">
          <input id="q1" type="radio" name="qdir" value="PT2ROMAJI" checked><label for="q1">PT ‚Üí Romaji</label>
          <input id="q2" type="radio" name="qdir" value="ROMAJI2PT"><label for="q2">Romaji ‚Üí PT</label>
          <input id="q3" type="radio" name="qdir" value="HIRA2PT"><label for="q3">Hiragana ‚Üí PT</label>
        </div>
        <div class="row" style="gap:6px">
          <label class="helper" for="qCat">Categoria:&nbsp;</label>
          <select id="qCat" class="select"><option value="todas">todas</option></select>
        </div>
      </div>

      <div class="prompt" id="qPrompt">Pergunta</div>
      <div class="qRow">
        <button title="Ouvir Japon√™s" class="audioBtn" id="qSpeakJP">üîä JP</button>
        <div class="question" id="qQuestion">‚Äî</div>
        <button title="Ouvir Portugu√™s" class="audioBtn" id="qSpeakPT">üîä PT</button>
      </div>

      <div class="choices" id="choices"></div>
      <div class="quizActions">
        <button class="btn secondary" id="qNext">Pr√≥ximo</button>
      </div>
      <div class="center helper" id="qFeedback" style="display:none"></div>
    </div>
  </section>

  <!-- ADD -->
  <section class="section" id="add">
    <div class="card">
      <div class="prompt">Adicionar novo card</div>
      <div class="inputRow">
        <input id="inRomaji" class="answer" placeholder="romaji (ex.: arigatou)" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false">
        <input id="inPT"     class="answer" placeholder="tradu√ß√µes PT (ex.: obrigado; obrigada)">
        <input id="inKana"   class="answer" placeholder="hiragana (opcional) ex.: „ÅÇ„Çä„Åå„Å®„ÅÜ">
        <input id="inCat"    class="answer" placeholder="categoria (ex.: saudacao)">
        <button class="btn" id="btnAdd">Adicionar</button>
      </div>
      <div class="helper">No bulk: <code>romaji ; pt1 ; pt2 ; #categoria ; „Å≤„Çâ„Åå„Å™(opcional)</code></div>
    </div>
    <div class="card">
      <div class="prompt">Importar em massa (colar lista)</div>
      <textarea class="bulk" id="bulk" placeholder="konnichiwa ; ol√° ; boa tarde ; #saudacao ; „Åì„Çì„Å´„Å°„ÅØ&#10;arigatou ; obrigado ; obrigada ; #saudacao ; „ÅÇ„Çä„Åå„Å®„ÅÜ"></textarea>
      <div class="center">
        <button class="btn secondary" id="btnParse">Pr√©-visualizar</button>
        <button class="btn" id="btnImport">Adicionar tudo</button>
      </div>
      <div id="preview" class="helper"></div>
    </div>
  </section>

  <!-- LIST -->
  <section class="section" id="list">
    <div class="card">
      <div class="prompt">Cartas (toque para remover)</div>
      <div class="tableWrap">
        <table class="list" id="table"></table>
      </div>
    </div>
  </section>

  <div class="kudos">Feito para iOS/Safari ‚Ä¢ Salva no navegador ‚Ä¢ Dire√ß√µes PT‚ÜîRomaji e Hiragana‚ÜíPT ‚Ä¢ √Åudio em hiragana ‚Ä¢ Filtro por categoria ‚Ä¢ Treino + Quiz</div>
  <div class="msg" id="msg" style="display:none"></div>
</div>

<script>
  // ===== CONFIG =====
  const DATA_URL = './anime_romaji.json';

  // ===== HELPERS / STORAGE =====
  const LS_DECK = 'romajiDeck_v8';
  const defaultDeck = [
    ["konnichiwa","ol√°; boa tarde","geral","„Åì„Çì„Å´„Å°„ÅØ"],
    ["ohayou","bom dia","geral","„Åä„ÅØ„Çà„ÅÜ"],
    ["konbanwa","boa noite (cumprimento)","geral","„Åì„Çì„Å∞„Çì„ÅØ"]
  ];
  const normBasic=s=>(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\([^)]*\)/g,' ').replace(/[\p{P}\p{S}]/gu,' ').replace(/\s+/g,' ').trim();
  const parsePT=pt=>(pt||'').split(/[|;,\n]/).map(normBasic).filter(Boolean);
  const isKana=s=>/[\u3040-\u309f\u30a0-\u30ff]/.test(s||'');
  function seed(list){return list.map(([romaji,pt,cat='geral',kana=''],i)=>({id:String(Date.now()+i),romaji:String(romaji||'').toLowerCase().trim(),pt:String(pt||'').toLowerCase().trim(),cat:String(cat||'geral').toLowerCase().trim(),kana:String(kana||'').trim(),ok:0,err:0}));}
  function migrate(arr){return arr.map(c=>({id:c.id||String(Date.now()+Math.random()),romaji:String(c.romaji||'').toLowerCase().trim(),pt:String(c.pt||'').toLowerCase().trim(),cat:String(c.cat||'geral').toLowerCase().trim(),kana:String(c.kana||c.hiragana||'').trim(),ok:c.ok||0,err:c.err||0}));}
  function loadDeckLS(){try{const raw=JSON.parse(localStorage.getItem(LS_DECK)); if(Array.isArray(raw)) return migrate(raw);}catch(e){} return null;}
  function saveDeck(){localStorage.setItem(LS_DECK, JSON.stringify(deck));}
  function toast(t,ms=1400){const el=document.querySelector('#msg'); el.textContent=t; el.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>el.style.display='none',ms);}

  // ===== √ÅUDIO =====
  let voices=[]; function loadVoices(){voices=window.speechSynthesis?speechSynthesis.getVoices():[]}
  if('speechSynthesis' in window){speechSynthesis.onvoiceschanged=loadVoices; loadVoices();}
  function romajiToHiragana(input){
    if(!input) return ''; let s=input.toLowerCase().trim().replace(/[^a-z0-9 ?!.,-]/g,' ').replace(/\s+/g,' ').trim().replace(/nn/g,'n');
    const yo={'kya':'„Åç„ÇÉ','kyu':'„Åç„ÇÖ','kyo':'„Åç„Çá','gya':'„Åé„ÇÉ','gyu':'„Åé„ÇÖ','gyo':'„Åé„Çá','sha':'„Åó„ÇÉ','shu':'„Åó„ÇÖ','sho':'„Åó„Çá','ja':'„Åò„ÇÉ','ju':'„Åò„ÇÖ','jo':'„Åò„Çá','jya':'„Åò„ÇÉ','jyu':'„Åò„ÇÖ','jyo':'„Åò„Çá','cha':'„Å°„ÇÉ','chu':'„Å°„ÇÖ','cho':'„Å°„Çá','nya':'„Å´„ÇÉ','nyu':'„Å´„ÇÖ','nyo':'„Å´„Çá','hya':'„Å≤„ÇÉ','hyu':'„Å≤„ÇÖ','hyo':'„Å≤„Çá','bya':'„Å≥„ÇÉ','byu':'„Å≥„ÇÖ','byo':'„Å≥„Çá','pya':'„Å¥„ÇÉ','pyu':'„Å¥„ÇÖ','pyo':'„Å¥„Çá','mya':'„Åø„ÇÉ','myu':'„Åø„ÇÖ','myo':'„Åø„Çá','rya':'„Çä„ÇÉ','ryu':'„Çä„ÇÖ','ryo':'„Çä„Çá'};
    const mp={'a':'„ÅÇ','i':'„ÅÑ','u':'„ÅÜ','e':'„Åà','o':'„Åä','ka':'„Åã','ki':'„Åç','ku':'„Åè','ke':'„Åë','ko':'„Åì','ga':'„Åå','gi':'„Åé','gu':'„Åê','ge':'„Åí','go':'„Åî','sa':'„Åï','shi':'„Åó','si':'„Åó','su':'„Åô','se':'„Åõ','so':'„Åù','za':'„Åñ','ji':'„Åò','zi':'„Åò','zu':'„Åö','ze':'„Åú','zo':'„Åû','ta':'„Åü','chi':'„Å°','ti':'„Å°','tsu':'„Å§','tu':'„Å§','te':'„Å¶','to':'„Å®','da':'„Å†','di':'„Å¢','du':'„Å•','de':'„Åß','do':'„Å©','na':'„Å™','ni':'„Å´','nu':'„Å¨','ne':'„Å≠','no':'„ÅÆ','ha':'„ÅØ','hi':'„Å≤','fu':'„Åµ','hu':'„Åµ','he':'„Å∏','ho':'„Åª','ba':'„Å∞','bi':'„Å≥','bu':'„Å∂','be':'„Åπ','bo':'„Åº','pa':'„Å±','pi':'„Å¥','pu':'„Å∑','pe':'„Å∫','po':'„ÅΩ','ma':'„Åæ','mi':'„Åø','mu':'„ÇÄ','me':'„ÇÅ','mo':'„ÇÇ','ya':'„ÇÑ','yu':'„ÇÜ','yo':'„Çà','ra':'„Çâ','ri':'„Çä','ru':'„Çã','re':'„Çå','ro':'„Çç','wa':'„Çè','wo':'„Çí','che':'„Å°„Åá','she':'„Åó„Åá','je':'„Åò„Åá'};
    let out='',i=0; const vow=c=>/[aeiou]/.test(c), cons=c=>/[bcdfghjklmnpqrstvwxyz]/.test(c);
    while(i<s.length){
      if(/\s/.test(s[i])){out+=' '; i++; continue;}
      if(/[?!.,-]/.test(s[i])){out+=s[i]; i++; continue;}
      if(i+1<s.length && s[i]===s[i+1] && cons(s[i]) && s[i]!=='n'){out+='„Å£'; i++; continue;}
      if(s[i]==='n'){const nx=s[i+1]||''; if(!nx||(!vow(nx)&&nx!=='y')){out+='„Çì'; i++; continue;}}
      const tri=s.slice(i,i+3); if(yo[tri]){out+=yo[tri]; i+=3; continue;}
      const triM=mp[tri]; if(triM){out+=triM; i+=3; continue;}
      const bi=s.slice(i,i+2); const biM=mp[bi]; if(biM){out+=biM; i+=2; continue;}
      const one=s[i]; const oneM=mp[one]; if(oneM){out+=oneM; i++; continue;}
      out+=s[i]; i++;
    }
    return out.replace(/\s{2,}/g,' ').trim();
  }
  function speakJP(text){
    if(!('speechSynthesis' in window)) return;
    const kana = isKana(text)? text : romajiToHiragana(text);
    if(!kana) return;
    const u=new SpeechSynthesisUtterance(kana);
    const pick=p=>voices.find(v=>v.lang && v.lang.toLowerCase().startsWith(p));
    const v=pick('ja-jp')||pick('ja'); if(v) u.voice=v;
    u.lang='ja-JP'; u.rate=0.95; u.pitch=1.0;
    try{speechSynthesis.cancel();}catch(_){}
    speechSynthesis.speak(u);
  }
  function speakPT(text){
    if(!('speechSynthesis' in window)) return;
    const u=new SpeechSynthesisUtterance(text);
    const pick=p=>voices.find(v=>v.lang && v.lang.toLowerCase().startsWith(p));
    const v=pick('pt-br')||pick('pt-pt')||voices[0]; if(v) u.voice=v;
    u.lang=v?.lang||'pt-BR'; u.rate=1.0; u.pitch=1.0;
    try{speechSynthesis.cancel();}catch(_){}
    speechSynthesis.speak(u);
  }

  // ===== STATE =====
  let deck = loadDeckLS() || seed(defaultDeck);
  const State = { modeTab:'study', direction:'PT2ROMAJI', catFilter:'todas', current:null, lastCorrect:false };
  const Quiz = { direction:'PT2ROMAJI', cat:'todas', current:null, choices:[] };

  // ===== UI helpers =====
  const el=s=>document.querySelector(s), els=s=>[...document.querySelectorAll(s)];
  function refreshCategoriesUI(){
    const cats=new Set(deck.map(c=>c.cat||'geral')); cats.add('todas');
    const sels=[el('#catFilter'), el('#qCat')];
    sels.forEach(sel=>{
      const cur=sel.value; sel.innerHTML='';
      [...cats].sort().forEach(c=>{const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o);});
      sel.value=cats.has(cur)?cur:'todas';
    });
  }
  function filteredByCategory(list, cat){ const k = cat || State.catFilter; if(k==='todas') return list; return list.filter(c=>(c.cat||'geral')===k); }
  function randomCard(cat){ const arr=filteredByCategory(deck,cat); return arr.length? arr[Math.floor(Math.random()*arr.length)] : null; }

  // ===== STUDY =====
  function renderQuestion(){
    const c=State.current; if(!c){ el('#qMain').textContent='Sem cartas nesta categoria.'; return; }
    const dir=State.direction;
    if(dir==='PT2ROMAJI'){ el('#promptLbl').textContent='Tradu√ß√£o (PT-BR)'; el('#helperLbl').innerHTML='Digite o <b>romaji</b> e pressione Verificar'; el('#qMain').textContent=(parsePT(c.pt)[0]||c.pt);}
    if(dir==='ROMAJI2PT'){ el('#promptLbl').textContent='Romaji'; el('#helperLbl').innerHTML='Digite uma tradu√ß√£o em <b>PT-BR</b> que sirva'; el('#qMain').textContent=c.romaji;}
    if(dir==='HIRA2PT'){ el('#promptLbl').textContent='Hiragana'; el('#helperLbl').innerHTML='Digite uma tradu√ß√£o em <b>PT-BR</b> que sirva'; el('#qMain').textContent=c.kana||romajiToHiragana(c.romaji);}
    el('#answer').value=''; el('#answer').classList.remove('correct','wrong'); el('#accepted').style.display='none';
    // bot√£o volta a "Pular"
    const sk=el('#btnSkip'); sk.textContent='Pular'; State.lastCorrect=false;
  }
  function pickNext(){ State.current = randomCard(); renderQuestion(); }

  // tabs
  els('.tab').forEach(b=>{
    b.addEventListener('click',()=>{
      els('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active');
      const tab=b.dataset.tab; els('.section').forEach(s=>s.classList.remove('active')); el('#'+tab).classList.add('active');
      State.modeTab=tab;
      if(tab==='study'){ if(!State.current) pickNext(); else renderQuestion(); }
      if(tab==='quiz'){ startQuizRound(); }
      if(tab==='list') renderTable();
    });
  });

  // dire√ß√£o (study) ‚Äî n√£o troca a carta
  els('input[name="dir"]').forEach(r=>{ r.addEventListener('change',()=>{ State.direction=r.value; renderQuestion(); }); });

  // categoria (study)
  el('#catFilter').addEventListener('change',()=>{ State.catFilter = el('#catFilter').value; pickNext(); });

  // verificar + pular/pr√≥ximo
  function checkAnswer(){
    const c=State.current; if(!c) return;
    const user=normBasic(el('#answer').value); let ok=false, feedback='';
    if(State.direction==='PT2ROMAJI'){
      ok = !!user && user===normBasic(c.romaji);
      feedback = `Romaji correto: <b>${c.romaji}</b> ‚Ä¢ <small>Tradu√ß√µes: ${parsePT(c.pt).join(' / ')}</small>`;
    } else { // ROMAJI2PT ou HIRA2PT
      const acc=new Set(parsePT(c.pt)); ok = !!user && acc.has(user);
      feedback = `Aceitas: <small>${[...acc].join(' / ')}</small>`;
    }
    const ans=el('#answer'); ans.classList.remove('correct','wrong'); ans.classList.add(ok?'correct':'wrong');
    el('#accepted').innerHTML=feedback; el('#accepted').style.display='block';
    toast(ok?'‚úî Correto!':'‚úò Quase!');
    if(ok){ c.ok++; State.lastCorrect=true; el('#btnSkip').textContent='Pr√≥ximo'; } else { c.err++; State.lastCorrect=false; el('#btnSkip').textContent='Pular'; }
    saveDeck();
  }
  el('#btnCheck').addEventListener('click', checkAnswer);
  el('#answer').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); checkAnswer(); }});
  el('#btnSkip').addEventListener('click', ()=>{ pickNext(); });
  // √°udio study
  el('#speakJP').addEventListener('click', ()=>{ const c=State.current; if(!c) return; const text=c.kana && isKana(c.kana) ? c.kana : c.romaji; speakJP(text); });
  el('#speakPT').addEventListener('click', ()=>{ const c=State.current; if(!c) return; const txt=(parsePT(c.pt)[0]||c.pt); speakPT(txt); });

  // ===== QUIZ =====
  function buildChoices(card, dir, cat){
    // cria 3 erradas + 1 correta, sem repetir
    const pool=filteredByCategory(deck,cat).filter(c=>c.id!==card.id);
    function pickWrong(n){
      const arr=[]; const used=new Set();
      while(arr.length<n && pool.length){
        const it=pool[Math.floor(Math.random()*pool.length)];
        const key = dir==='PT2ROMAJI' ? it.romaji : parsePT(it.pt)[0]||it.pt;
        if(used.has(key)) continue;
        used.add(key); arr.push(key);
      }
      return arr;
    }
    const correct = dir==='PT2ROMAJI' ? card.romaji : (parsePT(card.pt)[0]||card.pt);
    const wrong = pickWrong(3);
    const all = wrong.concat(correct);
    // embaralha
    for(let i=all.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [all[i],all[j]]=[all[j],all[i]];}
    return {options:all, correct};
  }
  function renderQuiz(){
    const c=Quiz.current; if(!c){ el('#qQuestion').textContent='Sem cartas nesta categoria.'; el('#choices').innerHTML=''; return;}
    const dir=Quiz.direction, cat=Quiz.cat;
    // pergunta
    if(dir==='PT2ROMAJI'){ el('#qPrompt').textContent='Tradu√ß√£o (PT-BR)'; el('#qQuestion').textContent=(parsePT(c.pt)[0]||c.pt); }
    if(dir==='ROMAJI2PT'){ el('#qPrompt').textContent='Romaji'; el('#qQuestion').textContent=c.romaji; }
    if(dir==='HIRA2PT'){ el('#qPrompt').textContent='Hiragana'; el('#qQuestion').textContent=c.kana||romajiToHiragana(c.romaji); }

    // choices
    const {options, correct}=buildChoices(c, dir, cat);
    Quiz.choices = options;
    const wrap=el('#choices'); wrap.innerHTML='';
    options.forEach(text=>{
      const b=document.createElement('button'); b.className='choice'; b.textContent=text;
      b.addEventListener('click', ()=>{
        const isCorrect = text===correct;
        b.classList.add(isCorrect?'correct':'wrong');
        if(isCorrect){ c.ok++; toast('‚úî Correto!'); } else { c.err++; toast('‚úò Quase!'); }
        saveDeck();
        // desabilita e revela correta
        [...wrap.children].forEach(btn=>{
          btn.disabled=true;
          if(btn.textContent===correct) btn.classList.add('correct');
        });
      });
      wrap.appendChild(b);
    });
    el('#qFeedback').style.display='none';
  }
  function startQuizRound(){
    Quiz.current = randomCard(Quiz.cat);
    renderQuiz();
  }
  // eventos quiz
  els('input[name="qdir"]').forEach(r=>{ r.addEventListener('change',()=>{ Quiz.direction=r.value; renderQuiz(); }); });
  el('#qCat').addEventListener('change',()=>{ Quiz.cat=el('#qCat').value; startQuizRound(); });
  el('#qNext').addEventListener('click', startQuizRound);
  // √°udio quiz
  el('#qSpeakJP').addEventListener('click', ()=>{ const c=Quiz.current; if(!c) return; const text=c.kana&&isKana(c.kana)?c.kana:c.romaji; speakJP(text); });
  el('#qSpeakPT').addEventListener('click', ()=>{ const c=Quiz.current; if(!c) return; const txt=(parsePT(c.pt)[0]||c.pt); speakPT(txt); });

  // ===== ADD / BULK =====
  function parseBulk(text){
    const out=[]; (text||'').split(/\r?\n/).forEach(line=>{
      line=line.trim(); if(!line) return;
      const parts=line.split(/\t|\s*;\s*/).map(s=>s.trim()).filter(Boolean);
      let cat='', kana=''; if(parts.length && /[\u3040-\u309f]/.test(parts[parts.length-1])) kana=parts.pop();
      if(parts.length && parts[parts.length-1].startsWith('#')) cat=parts.pop().slice(1);
      if(parts.length<2) return; const [romaji,...rest]=parts; out.push({romaji,pt:rest.join(';'),cat,kana});
    }); return out;
  }
  function addCard(r,p,cat,kana){
    const rom=normBasic(r), pt=normBasic(p), c=(cat||'geral').toLowerCase().trim()||'geral', k=String(kana||'').trim();
    if(!rom||!pt) return false; if(deck.some(x=>normBasic(x.romaji)===rom)) return false;
    deck.push({id:String(Date.now()+Math.random()*9999), romaji:rom, pt:pt, cat:c, kana:k, ok:0, err:0}); return true;
  }
  el('#btnAdd').addEventListener('click', ()=>{
    const ok = addCard(el('#inRomaji').value, el('#inPT').value, el('#inCat').value, el('#inKana').value);
    if(!ok){toast('Preencha corretamente ou evite duplicar romaji'); return;}
    saveDeck(); ['#inRomaji','#inPT','#inKana','#inCat'].forEach(s=>el(s).value=''); refreshCategoriesUI(); toast('Card adicionado!');
  });
  el('#btnParse').addEventListener('click', ()=>{ const arr=parseBulk(el('#bulk').value); el('#preview').innerHTML = arr.length?`Pronto para importar: <b>${arr.length}</b> linha(s).`:'Nada v√°lido.'; });
  el('#btnImport').addEventListener('click', ()=>{
    const arr=parseBulk(el('#bulk').value); if(!arr.length){toast('Nada v√°lido'); return;}
    let added=0,skipped=0; for(const it of arr){ if(addCard(it.romaji,it.pt,it.cat,it.kana)) added++; else skipped++; }
    saveDeck(); refreshCategoriesUI(); toast(`Importados: ${added}. Ignorados: ${skipped}.`); el('#bulk').value=''; el('#preview').textContent='';
  });

  // ===== LISTA =====
  function renderTable(){
    const t=el('#table'); t.innerHTML='';
    t.insertAdjacentHTML('beforeend',
      `<tr>
        <th class="col-idx">#</th>
        <th class="col-romaji">Romaji</th>
        <th class="col-kana">Hiragana</th>
        <th class="col-pt">Tradu√ß√µes</th>
        <th class="col-cat">Cat</th>
        <th class="col-ok">‚úì</th>
        <th class="col-err">‚úó</th>
      </tr>`);
    deck.slice().sort((a,b)=>a.romaji>b.romaji?1:-1).forEach((c,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=
        `<td class="col-idx">${i+1}</td>
         <td class="col-romaji">${c.romaji}</td>
         <td class="col-kana">${c.kana||''}</td>
         <td class="col-pt">${c.pt}</td>
         <td class="col-cat">${c.cat||'geral'}</td>
         <td class="col-ok" style="text-align:right">${c.ok||0}</td>
         <td class="col-err" style="text-align:right">${c.err||0}</td>`;
      tr.title='Toque para remover';
      tr.addEventListener('click',()=>{ deck=deck.filter(x=>x.id!==c.id); saveDeck(); renderTable(); refreshCategoriesUI(); toast('Removido.');});
      t.appendChild(tr);
    });
  }

  // ===== JSON remoto opcional =====
  async function hydrateFromJson(){
    try{
      const res=await fetch(DATA_URL,{cache:'no-store'}); if(!res.ok) return;
      const data=await res.json(); if(!Array.isArray(data)) return;
      let added=0; const have=new Set(deck.map(c=>normBasic(c.romaji)));
      data.forEach((obj,i)=>{
        const r=normBasic(obj.romaji), p=Array.isArray(obj.pt)?obj.pt.join(';'):String(obj.pt||''), c=String(obj.cat||'geral').toLowerCase(), k=String(obj.kana||obj.hiragana||'').trim();
        if(!r||!p||have.has(r)) return;
        deck.push({id:String(Date.now()+i), romaji:r, pt:parsePT(p).join('; '), cat:c, kana:k, ok:0, err:0}); have.add(r); added++;
      });
      if(added){ saveDeck(); refreshCategoriesUI(); }
    }catch(e){/* ignore em file:// */}
  }

  // ===== INIT =====
  (async function init(){
    deck = migrate(deck) || seed(defaultDeck);
    await hydrateFromJson();
    refreshCategoriesUI();
    // primeira carta (study) e primeira pergunta (quiz)
    State.current = randomCard();
    renderQuestion();
    Quiz.cat='todas'; startQuizRound();
  })();
</script>
</body>
</html>
