<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no" />
<meta name="mobile-web-app-capable" content="yes" />
<link rel="manifest" href="manifest.json"><!-- opcional; falha segura se ausente -->
<title>Flashcards (Romaji ↔ PT)</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#0b0f14; --card:#111827; --muted:#9fb3c8; --text:#e7eef7;
    --accent:#43b6ff; --accent2:#7cffad; --danger:#ff6b6b; --warn:#ffd166; --stroke:#223047;
    --radius:16px; --maxw:860px;
    --duo:#2bd463;
    --pill:#0f1422;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    overflow:hidden;
  }
  .app{
    height:100svh;
    display:flex; flex-direction:column; align-items:center; gap:12px;
    padding:env(safe-area-inset-top) 12px calc(12px + env(safe-area-inset-bottom)) 12px;
    overflow:auto; overscroll-behavior:contain;
  }
  header,.card,.tabs,.section{width:100%; max-width:var(--maxw)}
  header{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 4px}
  .brand{font-weight:800; color:var(--text); font-size:18px}
  .account{display:flex; align-items:center; gap:8px; color:var(--muted); font-weight:700}

  .tabs{display:grid; grid-template-columns:repeat(5,1fr); gap:8px}
  .tab{padding:10px 12px; text-align:center; background:var(--pill); color:var(--text);
    border-radius:999px; border:1px solid rgba(255,255,255,.06); font-weight:700}
  .tab.active{background:var(--duo); color:#05121d; border-color:transparent}

  .card{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius);
    padding:18px; display:flex; flex-direction:column; gap:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between}

  .seg{display:inline-flex; padding:4px; gap:4px; border-radius:999px; background:var(--pill); border:1px solid rgba(255,255,255,.06)}
  .seg input{display:none}
  .seg label{padding:10px 14px; border-radius:999px; font-weight:800; color:var(--text); cursor:pointer}
  .seg input:checked + label{background:var(--accent); color:#05121d}

  .prompt{text-align:center; color:var(--muted); font-weight:700; letter-spacing:.3px}
  .question{text-align:center; color:var(--text); font-weight:900; font-size:clamp(20px,6.5vw,40px); word-break:break-word}
  .qRow{display:flex; align-items:center; justify-content:center; gap:8px; flex-wrap:wrap}

  .audioBtn{height:38px; min-width:58px; padding:0 12px; border-radius:999px; background:var(--pill); color:var(--text);
    border:1px solid rgba(255,255,255,.08); font-weight:800; display:inline-flex; align-items:center; justify-content:center; gap:6px; cursor:pointer}

  .inputRow{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center}
  input.answer{flex:1 1 320px; max-width:560px; height:52px; background:#0f1422; border:2px solid var(--stroke);
    border-radius:14px; padding:0 14px; color:#e7eef7; font-size:18px; font-weight:700; outline:none}
  input.answer:focus{border-color:var(--accent)}
  input.answer.correct{border-color:var(--accent2); box-shadow:0 0 0 3px rgba(124,255,173,.15)}
  input.answer.wrong{border-color:var(--danger); box-shadow:0 0 0 3px rgba(255,107,107,.15)}
  select.select{height:44px; padding:0 12px; border-radius:12px; background:var(--pill); color:#e7eef7; border:2px solid var(--stroke); font-weight:700}

  .btn{height:52px; padding:0 16px; border-radius:14px; font-weight:800; border:1px solid rgba(255,255,255,.08); background:var(--duo); color:#05121d; cursor:pointer}
  .btn.secondary{background:#1f2937; color:#e7eef7}
  .btn.small{height:32px; padding:0 12px;}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .btn:focus, .choice:focus, .audioBtn:focus {outline:3px solid rgba(67,182,255,.6); outline-offset:2px}

  .center{display:flex; justify-content:center; gap:10px; flex-wrap:wrap}
  .helper{color:var(--muted); text-align:center; font-size:13px}
  .okText{color:var(--accent2); font-weight:800}
  .section{display:none}
  .section.active{display:block}

  .flash{padding:8px 12px; border-radius:10px; font-weight:800; text-align:center}
  .flash.ok{background:#063; color:#c6ffde}
  .flash.err{background:#4a1212; color:#ffc6c6}

  .tableWrap{max-width:100%; overflow:auto; border-radius:12px; overscroll-behavior:contain}
  table.list{width:100%; border-collapse:separate; border-spacing:0 6px; table-layout:fixed}
  table.list th,table.list td{padding:10px 12px; text-align:left; font-size:14px; word-break:break-word; white-space:normal}
  table.list th{color:var(--muted); font-weight:800}
  table.list tr{background:#0f1422; border:1px solid rgba(255,255,255,.08)}
  table.list tr td:first-child{border-radius:12px 0 0 12px}
  table.list tr td:last-child{border-radius:0 12px 12px 0}
  .col-idx{width:48px; min-width:48px}
  .col-romaji{width:28%}
  .col-kana{width:22%}
  .col-pt{width:32%; overflow-wrap:anywhere}
  .col-cat{width:12%}
  .col-ok,.col-err{width:48px; text-align:right}

  .choices{display:grid; grid-template-columns:repeat(2,minmax(160px,1fr)); gap:10px}
  .choice{padding:12px; border-radius:14px; border:2px solid var(--stroke); background:#0f1422; color:#e7eef7; font-weight:800; cursor:pointer}
  .choice:hover{border-color:var(--accent)}
  .choice.correct{border-color:var(--accent2)}
  .choice.wrong{border-color:var(--danger)}

  .kudos{position:fixed; right:10px; bottom:10px; color:#5b708a; font-weight:800; font-size:12px}
  .msg{position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#0f1422; color:#e7eef7; padding:10px 14px; border:1px solid rgba(255,255,255,.12); border-radius:12px; font-weight:800}

  @media (max-width:600px){
    .brand{font-size:16px}
    .tab{padding:8px 10px}
    .card{padding:14px}
    table.list th,table.list td{font-size:12px; padding:8px 10px}
    .col-idx,.col-kana{display:none}
    .col-romaji{width:36%}
    .col-pt{width:42%}
    .col-cat{width:14%}
    .col-ok,.col-err{width:40px}
    .choices{grid-template-columns:1fr}
  }
  textarea.bulk{min-height:140px; width:100%; background:#0f1422; color:#e7eef7; border:2px solid var(--stroke); border-radius:14px; padding:10px; font-weight:700}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="brand">Flashcards — Romaji ↔ PT</div>
    <div class="account">
      <div class="helper" id="streak">Streak: 0</div>
      <span id="userEmail"></span>
      <button id="btnSignOut" class="btn secondary small">Sair</button>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" data-tab="study">Estudar</button>
    <button class="tab" data-tab="quiz">Quiz</button>
    <button class="tab" data-tab="reinforce">Reforço</button>
    <button class="tab" data-tab="add">+</button>
    <button class="tab" data-tab="list">Lista</button>
  </div>

  <section class="section active" id="study">
    <div class="card">
      <div class="row">
        <div class="seg" aria-label="Direção">
          <input id="d1" type="radio" name="dir" value="PT2ROMAJI" checked><label for="d1">PT → Romaji</label>
          <input id="d2" type="radio" name="dir" value="ROMAJI2PT"><label for="d2">Romaji → PT</label>
          <input id="d3" type="radio" name="dir" value="HIRA2PT"><label for="d3">Hiragana → PT</label>
        </div>
        <div class="row" style="gap:6px">
          <label class="helper" for="catFilter">Categoria:&nbsp;</label>
          <select id="catFilter" class="select"><option value="todas">todas</option></select>
        </div>
      </div>

      <div class="prompt" id="promptLbl">Tradução (PT-BR)</div>
      <div class="qRow">
        <button title="Ouvir Japonês" class="audioBtn" id="speakJP">JP</button>
        <div class="question" id="qMain">—</div>
        <button title="Ouvir Português" class="audioBtn" id="speakPT">PT</button>
      </div>
      <div class="center helper" id="helperLbl">Digite o <b>romaji</b> e pressione Verificar</div>

      <div class="inputRow">
        <input id="answer" class="answer" placeholder="ex.: konnichiwa"
          autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
          inputmode="latin" enterkeyhint="done">
        <button class="btn" id="btnCheck" disabled>Verificar</button>
        <button class="btn secondary" id="btnSkip">Pular</button>
      </div>

      <div class="center helper" id="accepted" style="display:none" aria-live="polite"></div>
    </div>
  </section>

  <section class="section" id="quiz">
    <div class="card">
      <div class="row">
        <div class="seg" aria-label="Direção quiz">
          <input id="q1" type="radio" name="qdir" value="PT2ROMAJI" checked><label for="q1">PT → Romaji</label>
          <input id="q2" type="radio" name="qdir" value="ROMAJI2PT"><label for="q2">Romaji → PT</label>
          <input id="q3" type="radio" name="qdir" value="HIRA2PT"><label for="q3">Hiragana → PT</label>
        </div>
        <div class="row" style="gap:6px">
          <label class="helper" for="qCat">Categoria:&nbsp;</label>
          <select id="qCat" class="select"><option value="todas">todas</option></select>
        </div>
      </div>

      <div class="prompt" id="qPrompt">Pergunta</div>
      <div class="qRow">
        <button title="Ouvir Japonês" class="audioBtn" id="qSpeakJP">JP</button>
        <div class="question" id="qQuestion">—</div>
        <button title="Ouvir Português" class="audioBtn" id="qSpeakPT">PT</button>
      </div>

      <div class="choices" id="choices"></div>
      <div class="quizActions">
        <button class="btn secondary" id="qNext">Próximo</button>
      </div>
      <div class="center helper" id="qFeedback" style="display:none" aria-live="polite"></div>
    </div>
  </section>

  <!-- REFORÇO 2.0 -->
  <section class="section" id="reinforce"> ... <!-- (seu conteúdo permanece igual) --> </section>

  <section class="section" id="add"> ... </section>

  <section class="section" id="list">
    <div class="card">
      <div class="prompt">Cartas (toque para remover)</div>
      <div class="row" style="justify-content:flex-end;gap:8px;margin:6px 0">
        <span class="helper" id="pendingLbl" style="margin-right:auto">Alterações pendentes: 0</span>
        <button class="btn secondary small" id="btnDiscard" title="Descartar alterações locais">Descartar</button>
        <button class="btn small" id="btnSync" title="Enviar alterações ao servidor">Atualizar</button>
      </div>
      <div class="tableWrap">
        <table class="list" id="table"></table>
      </div>
    </div>
  </section>

  <div class="kudos">JP-PT</div>
  <div class="msg" id="msg" style="display:none"></div>
</div>

<script type="module">
/* anti-duplo init */
if (window.__JPPT_INIT__) { console.warn('index init duplicado – ignorando'); throw new Error('Double init'); }
window.__JPPT_INIT__ = true;

import { onAuthState, signOutUser } from './auth.js';
import {
  loadUserDeck, saveUserDeck, migrateFromLocalStorage, getDeletedRomajiSet,
  upsertMany, cacheDeck, deleteMany, markDeletedRomajiMany, drainQueues
} from './store.js';

/* ===== helpers, audio, TTS, estado, etc. ===== */
/*  (todo o bloco do seu arquivo continua igual até a seção do QUIZ;
    mantive as melhorias de robustez que você já aplicou)  */

/* ... todo o código anterior que você já tem (sons, TTS, SRS, ciclos, Study, etc.) ... */

/* ===== QUIZ ===== */
function valFor(card, dir){ return dir==='PT2ROMAJI' ? card.romaji : (parsePT(card.pt)[0]||card.pt); }
function buildChoices(card, dir, cat){
  let pool = filteredByCategory(deck,cat).filter(c=>c.id!==card.id);
  if(pool.length < 3) pool = deck.filter(c=>c.id!==card.id);
  const correct = valFor(card, dir);
  const used=new Set([correct]); const opts=[];
  while(opts.length<3 && pool.length){
    const it=pool[Math.floor(Math.random()*pool.length)];
    const k=valFor(it, dir);
    if(!used.has(k)){ used.add(k); opts.push(k); }
  }
  const all=[...opts, correct].sort(()=>Math.random()-0.5);
  return {options:all, correct};
}
function renderQuiz(){
  const c=Quiz.current; if(!c){ el('#qQuestion').textContent='Sem cartas nesta categoria.'; el('#choices').innerHTML=''; return;}
  const dir=Quiz.direction, cat=Quiz.cat;
  if(dir==='PT2ROMAJI'){ el('#qPrompt').textContent='Tradução (PT-BR)'; el('#qQuestion').textContent=(parsePT(c.pt)[0]||c.pt); }
  if(dir==='ROMAJI2PT'){ el('#qPrompt').textContent='Romaji'; el('#qQuestion').textContent=c.romaji; }
  if(dir==='HIRA2PT'){ el('#qPrompt').textContent='Hiragana'; el('#qQuestion').textContent=c.kana||romajiToHiragana(c.romaji); }

  const {options, correct}=buildChoices(c, dir, cat);
  const wrap=el('#choices'); wrap.innerHTML='';
  options.forEach(text=>{
    const b=document.createElement('button'); b.className='choice'; b.textContent=text; b.setAttribute('tabindex','0');
    b.addEventListener('click', ()=>{
      if(b.disabled) return;

      // >>> CORREÇÃO: falar a própria opção clicada
      if (dir === 'ROMAJI2PT' || dir === 'HIRA2PT') {
        speakPT(text);
      } else { // PT2ROMAJI -> opções são romaji: fala JP dessa opção
        const jpOpt = isKana(text) ? text : romajiToHiragana(text);
        speakJP(jpOpt);
      }

      const isCorrect = text===correct;
      b.classList.add(isCorrect?'correct':'wrong');
      playSFX(isCorrect ? 'ok' : 'err', 280);

      if(isCorrect){
        c.ok++; rateCard(c,true); toast('✔ Correto!'); flash('Correto!',true);
      } else {
        c.err++; rateCard(c,false); toast('✘ Quase!');  flash('Quase...',false);
      }

      cacheDeck(window.CURRENT_UID, deck);
      queueUpsert(c.id);

      [...wrap.children].forEach(btn=>{
        btn.disabled = true;
        if(btn.textContent===correct) btn.classList.add('correct');
      });
    });
    wrap.appendChild(b);
  });
  el('#qFeedback').style.display='none';
}
function startQuizRound(){
  Quiz.current = nextFromCycle('quiz', Quiz.cat);
  renderQuiz();
}
els('input[name="qdir"]').forEach(r=>{ r.addEventListener('change',()=>{ Quiz.direction=r.value; renderQuiz(); }); });
el('#qCat').addEventListener('change',()=>{ Quiz.cat=el('#qCat').value; startQuizRound(); });
el('#qNext').addEventListener('click', startQuizRound);

/* ===== resto do arquivo (Reforço, Add/Bulk, Lista, Hydrate, Init) permanece igual ===== */

/* ===== SYNC (Atualizar / Descartar) — CORRIGIDO ===== */
document.getElementById('btnSync').addEventListener('click', async () => {
  const uid = window.CURRENT_UID;
  if (!uid) { toast('Você precisa estar logado.'); return; }

  try {
    const upsertList = deck.filter(c => Pending.upserts.has(String(c.id)));
    if (upsertList.length) await upsertMany(uid, upsertList);

    const delIds = [...Pending.deletions];
    if (delIds.length) await deleteMany(uid, delIds);

    const tombs = [...Pending.tombs];
    if (tombs.length) await markDeletedRomajiMany(uid, tombs);

    // tenta drenar as filas persistentes e checa se zerou
    const left = await drainQueues(uid);

    if (left === 0) {
      Pending.deletions.clear();
      Pending.tombs.clear();
      Pending.upserts.clear();
      refreshPending();
      try { localStorage.removeItem('unsynced'); } catch {}
      toast('Sincronizado com o servidor!');
    } else {
      refreshPending();
      toast('Alterações enfileiradas. Vamos sincronizar automaticamente quando a cota voltar.');
    }
  } catch (e) {
    console.error(e);
    toast('Erro ao sincronizar: ' + (e?.code || e?.message || 'desconhecido'));
  }
});

document.getElementById('btnDiscard').addEventListener('click', () => {
  Pending.deletions.clear();
  Pending.tombs.clear();
  Pending.upserts.clear();
  refreshPending();
  toast('Alterações pendentes descartadas.');
});

// ===== PWA (opcional, falha segura) =====
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => { /* ok se não existir */ });
}
</script>
</body>
</html>
