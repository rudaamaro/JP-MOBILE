<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <!-- Mobile-first, web app e safe areas -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Flashcards JP‚ÜîPT ‚Äî Mobile</title>
  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; margin: 0; background:#0b0f14; }
    body { overscroll-behavior: none; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    #stage { position: fixed; inset: 0; }
    canvas { display:block; width:100vw; height:100vh; }

    /* INPUT OVERLAY: abre teclado nativo no celular */
    .overlay-input {
      position: fixed; z-index: 10; left: 0; top: 0; width: 1px; height: 1px;
      opacity: 0; pointer-events: none; border: none; outline: none;
      background: #0f1422; color: #e7eef7; font: 500 clamp(16px, 2.5vh, 20px) system-ui;
      -webkit-user-select: text; user-select: text;
    }
    .overlay-input.visible {
      opacity: 1; pointer-events: auto; border-radius: 12px; padding: 12px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.08);
    }

    /* Espa√ßo p/ a barra inferior n√£o ficar colada no gesto home */
    .safe-bottom { height: calc(env(safe-area-inset-bottom, 0px)); }
  </style>
</head>
<body>
  <div id="stage">
    <canvas id="app"></canvas>
  </div>
  <!-- Campo real para abrir o teclado (sincronizado com o Canvas) -->
  <input id="mobileInput" class="overlay-input" inputmode="text" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" placeholder="" />

  <script>
  // =========================
  //  MOBILE-FIRST CANVAS APP
  // =========================
  const cvs = document.getElementById('app');
  const ctx = cvs.getContext('2d');
  const mobileInput = document.getElementById('mobileInput');

  const IS_TOUCH = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  const IS_MOBILE = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (Math.min(window.innerWidth, window.innerHeight) < 768);

  // =========================
  //  FIX: declarar C e SIZES antes de usar updateSizes()
  // =========================
  // Cores
  const C={card:'#121826',accent:'#43b6ff',accent2:'#7cffad',text:'#e7eef7',sub:'#9fb3c8',danger:'#ff6b6b',warn:'#ffd166',stroke:'rgba(255,255,255,0.08)'};

  // Tamanhos ajustados para mobile
  const SIZES = {
    headerH: 56,
    footerH: 72,
    cardPad: 16,
    bigTitle: 20,
    pillH: 34,
    buttonH: 48,
    hiraganaStudyFactor: 0.12,
    hiraganaStudyMin: 24,
    hiraganaQuizPx: 18,
    hiraganaManagePx: 12
  };

  function updateSizes(){
    const base = Math.min(window.innerWidth, window.innerHeight);
    SIZES.headerH = Math.max(48, Math.floor(base * 0.08));
    SIZES.footerH = Math.max(64, Math.floor(base * 0.12));
    SIZES.cardPad = Math.max(12, Math.floor(base * 0.04));
    SIZES.pillH = Math.max(28, Math.floor(base * 0.07));
    SIZES.buttonH = Math.max(44, Math.floor(base * 0.1));
  }
  // =========================

  function fitCanvas(){
    const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    const w = Math.floor(window.innerWidth), h = Math.floor(window.innerHeight);
    cvs.width = w * dpr; cvs.height = h * dpr;
    cvs.style.width = w + 'px'; cvs.style.height = h + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  window.addEventListener('resize', () => { fitCanvas(); updateSizes(); hideMobileInput(); });
  // Chamar ap√≥s as declara√ß√µes
  fitCanvas();
  updateSizes();

  // Utilit√°rios de desenho
  function roundRect(x,y,w,h,r=16){ r=Math.min(r, Math.min(w,h)/2); ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function drawButton(b){
    const {x,y,w,h,label,fill=C.accent,stroke=C.stroke,text=C.text}=b;
    roundRect(x,y,w,h,14);
    ctx.fillStyle=fill;ctx.fill();
    if(stroke){ctx.strokeStyle=stroke;ctx.lineWidth=1;ctx.stroke();}
    ctx.fillStyle=text;
    let fontSize = Math.max(13, Math.floor(h*0.42));
    ctx.font=`700 ${fontSize}px system-ui`;
    while(ctx.measureText(String(label)).width > w-16 && fontSize>10){
      fontSize -=1;
      ctx.font=`700 ${fontSize}px system-ui`;
    }
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText(String(label),x+w/2,y+h/2+1);
  }
  function drawIconButton(b,icon){const {x,y,w,h,fill=C.accent}=b; roundRect(x,y,w,h,14); ctx.fillStyle=fill; ctx.fill(); ctx.strokeStyle=C.stroke; ctx.stroke(); ctx.fillStyle='#06131f'; ctx.font=`700 ${Math.max(14,Math.floor(h*0.6))}px system-ui`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(icon,x+w/2,y+h/2+1);} 
  function drawPill(p){const {x,y,w,h,label,active=false}=p; roundRect(x,y,w,h,999); ctx.fillStyle=active?C.accent:'#1f2937'; ctx.fill(); ctx.strokeStyle=active?'rgba(67,182,255,0.5)':C.stroke; ctx.stroke(); ctx.fillStyle=active?'#06131f':C.text; ctx.font='700 13px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(label,x+w/2,y+h/2+1);}  
  function drawInputBox(inp){const {x,y,w,h,label,value,placeholder='',focused=false}=inp;roundRect(x,y,w,h,12);ctx.fillStyle='#0f1422';ctx.fill();ctx.strokeStyle=focused?C.accent:C.stroke;ctx.lineWidth=focused?2:1;ctx.stroke();ctx.fillStyle=C.sub;ctx.font='700 12px system-ui';ctx.textAlign='left';ctx.textBaseline='top';if(label)ctx.fillText(label,x+12,y+8);ctx.font='600 18px system-ui';ctx.fillStyle=value?C.text:'rgba(231,238,247,0.4)';const shown=value||placeholder;ctx.fillText(shown+(focused&&tick()%60<30?'|':''),x+12,y+(label?28:12));}
  function drawProgressBar(x,y,w,h,p){roundRect(x,y,w,h,12);ctx.fillStyle='#0f1422';ctx.fill();const ww=Math.max(0,Math.min(1,p))*w;roundRect(x,y,ww,h,12);const g=ctx.createLinearGradient(x,y,x+w,y);g.addColorStop(0,C.accent);g.addColorStop(1,C.accent2);ctx.fillStyle=g;ctx.fill();ctx.strokeStyle=C.stroke;ctx.stroke();ctx.font='700 12px system-ui';ctx.fillStyle=C.text;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(Math.round(Math.max(0,Math.min(1,p))*100)+'%',x+w/2,y+h/2);}  

  // √Årea oculta p/ colar (mantida)
  const pasteArea=document.createElement('textarea'); pasteArea.style.position='fixed'; pasteArea.style.opacity='0'; pasteArea.style.pointerEvents='none'; document.body.appendChild(pasteArea);

  // LocalStorage / deck
  const LS_KEYS={deck:'jpDeck_v5',stats:'jpStats_v2'};
  function todayStr(d=new Date()){const y=d.getFullYear(),m=('0'+(d.getMonth()+1)).slice(-2),day=('0'+d.getDate()).slice(-2);return `${y}-${m}-${day}`;}
  function addDays(iso,n){const d=new Date(iso+'T00:00:00');d.setDate(d.getDate()+n);return todayStr(d);}  

  const defaultDeck=[
    {id:'1',hiragana:'„Åì„Çì„Å´„Å°„ÅØ',romaji:'konnichiwa',pt:'ol√°|ola|boa tarde',due:todayStr(),ef:2.5,ivl:0,reps:0,ok:0,err:0,cat:'none'},
    {id:'2',hiragana:'„ÅÇ„Çä„Åå„Å®„ÅÜ',romaji:'arigatou',pt:'obrigado|obrigada',due:todayStr(),ef:2.5,ivl:0,reps:0,ok:0,err:0,cat:'none'},
    {id:'3',hiragana:'„Åô„Åø„Åæ„Åõ„Çì',romaji:'sumimasen',pt:'desculpa|com licen√ßa|com licenca',due:todayStr(),ef:2.5,ivl:0,reps:0,ok:0,err:0,cat:'none'}
  ];
  function migrate(a){
    return (a||[]).map(c=>({
      id:c.id||String(Date.now()+Math.random()),
      hiragana:c.hiragana||'',
      romaji:(c.romaji||'').toLowerCase(),
      pt:(c.pt||'').toLowerCase(),
      due:c.due||todayStr(),
      ef:typeof c.ef==='number'?c.ef:2.5,
      ivl:typeof c.ivl==='number'?c.ivl:0,
      reps:c.reps||0, ok:c.ok||0, err:c.err||0,
      cat:(c.cat==='dificil'||c.cat==='medio'||c.cat==='facil')?c.cat:'none'
    }));
  }
  function loadDeck(){try{return migrate(JSON.parse(localStorage.getItem(LS_KEYS.deck))||defaultDeck.slice());}catch(e){return defaultDeck.slice();}}
  function saveDeck(){localStorage.setItem(LS_KEYS.deck,JSON.stringify(deck));}
  const defaultStats={streak:0,lastStudy:null,studiedToday:0,dailyGoal:20};
  function loadStats(){try{return Object.assign({},defaultStats,JSON.parse(localStorage.getItem(LS_KEYS.stats)||'{}'));}catch(e){return {...defaultStats};}}
  function saveStats(){localStorage.setItem(LS_KEYS.stats,JSON.stringify(stats));}

  let deck=loadDeck(); let stats=loadStats();
  function applyRollover(){const t=todayStr(); if(!stats.lastStudy){stats.lastStudy=t;stats.studiedToday=0;saveStats();return;} if(stats.lastStudy!==t){const y=new Date(stats.lastStudy+'T00:00:00');const d=new Date(t+'T00:00:00');const diff=Math.round((d-y)/86400000);stats.streak=(diff===1)?(stats.streak+1):1;stats.studiedToday=0;stats.lastStudy=t;saveStats();}} applyRollover();

  // SRS
  function schedule(card,grade){const minEF=1.3; if(grade===0){card.err=(card.err||0)+1; card.reps=0; card.ef=Math.max(minEF,(card.ef||2.5)-0.2); card.ivl=1; card.due=addDays(todayStr(),1); return;} card.ok=(card.ok||0)+1; const ef=card.ef||2.5; if(card.reps===0){card.ivl=(grade===2)?3:1;} else {const mult=grade===2?(ef*1.3):ef; card.ivl=Math.max(1,Math.round(card.ivl*mult));} card.ef=Math.max(minEF,ef+(grade===2?+0.10:-0.05)); card.reps=(card.reps||0)+1; card.due=addDays(todayStr(),card.ivl);}  

  // Estado
  const State={
    mode:'study', // mobile: j√° cai no modo principal
    input:'',
    showAnswer:false,
    focusField:null,
    addForm:{hiragana:'',romaji:'',pt:''},
    message:'',
    manage:{page:0,pageSize:10,selected:null,sort:'due'},
    bulkText:'',
    trainFilter:'todas',
    quiz:{current:null, options:[], correctIndex:-1, selectedIndex:-1}
  };

  // Normaliza√ß√£o
  function normalizeBasic(s){
    return (s||'')
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/\([^)]*\)/g, ' ')
      .replace(/[\p{P}\p{S}]/gu, ' ')
      .replace(/\s+/g, ' ')
      .trim();
  }
  function parseAnswers(pt){return (pt||'').split(/[|;,]/).map(normalizeBasic).filter(Boolean);}  

  function dueCards(){const t=todayStr(); return deck.filter(c => (c.due||t) <= t);} 
  let currentCard=null;
  function pickNext(){ const p=dueCards(); currentCard=p.length?p[Math.floor(Math.random()*p.length)]:null; State.input=''; State.showAnswer=false; }
  function trainPool(){ if(State.trainFilter==='todas') return deck; return deck.filter(c=>c.cat===State.trainFilter); }
  function pickNextTrain(){ const pool=trainPool(); currentCard=pool.length?pool[Math.floor(Math.random()*pool.length)]:null; State.input=''; State.showAnswer=false; }

  // Quiz
  function shuffleInPlace(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } }
  function startQuizQuestion(){
    if(deck.length===0){ State.quiz={current:null,options:[],correctIndex:-1,selectedIndex:-1}; return; }
    const idx=Math.floor(Math.random()*deck.length);
    const card=deck[idx];
    const answers=parseAnswers(card.pt);
    const correctPT = answers[Math.floor(Math.random()*Math.max(1,answers.length))] || '';
    const pool = deck.filter((c,i)=> i!==idx && parseAnswers(c.pt).length>0);
    shuffleInPlace(pool);
    const distractors = [];
    const used = new Set([normalizeBasic(correctPT)]);
    for(const c of pool){ if(distractors.length>=3) break; const list=parseAnswers(c.pt); if(list.length===0) continue; const pick=list[Math.floor(Math.random()*list.length)]; const norm=normalizeBasic(pick); if(!used.has(norm)) { used.add(norm); distractors.push(pick); } }
    while(distractors.length<3){ distractors.push('‚Äî'); }
    const options=[correctPT, ...distractors.slice(0,3)];
    const order=[0,1,2,3]; shuffleInPlace(order);
    const mapped = order.map(i=>options[i]);
    const correctIndex = order.indexOf(0);
    State.quiz={current:card, options:mapped, correctIndex:correctIndex, selectedIndex:-1};
  }
  function selectQuizOption(index){ if(State.quiz.selectedIndex!==-1) return; State.quiz.selectedIndex=index; const ok = index===State.quiz.correctIndex; State.message = ok? '‚úî Correto!':'‚úò Resposta incorreta.'; }
  function nextQuiz(){ startQuizQuestion(); State.message=''; }

  // TTS JP
  function speakJP(t){ if(!('speechSynthesis'in window)){ State.message='TTS n√£o suportado'; return; } const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; const vs=speechSynthesis.getVoices(); const jp=vs.find(v=>/ja-JP|Japanese/i.test(v.lang+v.name))||vs.find(v=>/ja|JP|Japanese/i.test(v.lang+v.name)); if(jp)u.voice=jp; u.rate=0.95; speechSynthesis.cancel(); speechSynthesis.speak(u); }
  if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged=()=>{}; }

  // -----------------------
  //   TECLADO (overlay)
  // -----------------------
  let overlayBind = { mode: null, field: null };
  function showMobileInput(x, y, w, h, value, placeholder, bind){
    mobileInput.style.left = Math.round(x) + 'px';
    mobileInput.style.top  = Math.round(y) + 'px';
    mobileInput.style.width  = Math.round(w) + 'px';
    mobileInput.style.height = Math.round(h) + 'px';
    mobileInput.value = value || '';
    mobileInput.placeholder = placeholder || '';
    overlayBind = bind || {mode:null, field:null};
    mobileInput.classList.add('visible');
    // Empurra um pouco para cima da √°rea segura do iOS
    const pad = parseInt(getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-bottom)') || '0', 10) || 0;
    mobileInput.style.paddingBottom = (12 + pad) + 'px';
    mobileInput.focus({ preventScroll: true });
    // Seleciona fim do texto
    requestAnimationFrame(()=>{ const v = mobileInput.value; mobileInput.setSelectionRange(v.length, v.length); });
  }
  function hideMobileInput(){ mobileInput.classList.remove('visible'); overlayBind={mode:null, field:null}; }

  // Sincroniza texto digitado no input real com o estado
  mobileInput.addEventListener('input', ()=>{
    const val = mobileInput.value;
    if(overlayBind.mode==='study'){
      State.input = val;
    } else if(overlayBind.mode==='add'){
      if(overlayBind.field && State.addForm.hasOwnProperty(overlayBind.field)){
        State.addForm[overlayBind.field] = val;
      }
    } else if(overlayBind.mode==='bulk'){
      State.bulkText = val;
    }
  });
  // Enter confirma
  mobileInput.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){
      if(overlayBind.mode==='study'){ hideMobileInput(); checkAnswer(); }
      if(overlayBind.mode==='add' && overlayBind.field){ hideMobileInput(); addCardFromForm(); }
      if(overlayBind.mode==='bulk'){ /* nada */ }
      e.preventDefault();
    }
    if(e.key==='Escape'){ hideMobileInput(); }
  });

  // -----------------------
  //  INPUTS / CLIQUES
  // -----------------------
  function clientToCanvas(evt){
    const r = cvs.getBoundingClientRect();
    const x = (evt.clientX ?? (evt.touches && evt.touches[0].clientX)) - r.left;
    const y = (evt.clientY ?? (evt.touches && evt.touches[0].clientY)) - r.top;
    return { x, y };
  }

  const mouse={x:0,y:0,down:false};
  function addPointerListeners(){
    if(IS_TOUCH){
      cvs.addEventListener('touchstart', (e)=>{ const p=clientToCanvas(e); mouse.x=p.x; mouse.y=p.y; mouse.down=true; handleClick(p.x,p.y); }, {passive:true});
      cvs.addEventListener('touchmove', (e)=>{ const p=clientToCanvas(e); mouse.x=p.x; mouse.y=p.y; }, {passive:true});
      cvs.addEventListener('touchend', ()=>{ mouse.down=false; });
      // Evita gesture zoom
      document.addEventListener('gesturestart', e=>e.preventDefault());
    }
    // Mouse tamb√©m (desktop)
    cvs.addEventListener('mousemove', e=>{ const r=cvs.getBoundingClientRect(); mouse.x=e.clientX-r.left; mouse.y=e.clientY-r.top; });
    cvs.addEventListener('mousedown', e=>{ mouse.down=true; handleClick(mouse.x,mouse.y); });
    window.addEventListener('mouseup', ()=>{ mouse.down=false; });
  }
  addPointerListeners();

  function hit(b,x,y){return x>=b.x&&x<=b.x+b.w&&y>=b.y&&y<=b.y+b.h;}
  function handleClick(x,y){ const u=layout(); const all=[...u.buttons,...u.clickZones]; for(const b of all){ if(hit(b,x,y)){ b.onClick&&b.onClick(); return; } } }

  // -----------------------
  //  LAYOUT MOBILE-FIRST
  // -----------------------
  function layout(){
    const W = cvs.clientWidth, H = cvs.clientHeight;
    const headerH = SIZES.headerH;
    const footerH = SIZES.footerH;
    const pad = SIZES.cardPad;

    const topBar = { x:0, y:0, w:W, h:headerH };
    const bottomBar = { x:0, y:H-footerH, w:W, h:footerH };

    // √Årea principal (cart√£o)
    const cardX = pad;
    const cardY = topBar.y + topBar.h + pad;
    const cardW = W - pad*2;
    const cardH = Math.max(220, H - (topBar.h + footerH + pad*3));

    const card = { x:cardX, y:cardY, w:cardW, h:cardH };
    const buttons=[], clickZones=[], inputs=[];

    // Bot√µes inferiores como "aba" (Estudar/Treinar/Quiz/Resumo/Lista)
    const tabW = Math.max(40, Math.floor((W - pad*2 - 4*8)/5)); // 5 abas, gaps 8px
    const tabY = bottomBar.y + 12;
    const makeTab = (i, label, onClick, fill) => ({ x: pad + i*(tabW+8), y: tabY, w: tabW, h: bottomBar.h-24, label, onClick, fill: fill || '#1f2937' });

    buttons.push(
      makeTab(0, 'Estudar', ()=>{ State.mode='study'; pickNext(); }),
      makeTab(1, 'Treinar', ()=>{ State.mode='train'; pickNextTrain(); }, '#0ea5e9'),
      makeTab(2, 'Quiz',    ()=>{ State.mode='quiz'; startQuizQuestion(); }, '#f59e0b'),
      makeTab(3, 'Resumo',  ()=>{ State.mode='summary'; }, '#8b5cf6'),
      makeTab(4, 'Lista',   ()=>{ State.mode='manage'; }, '#334155')
    );

    // Engrenagem (adicionar) no topo esquerdo
    const gear = { x: pad, y: Math.floor(topBar.y + (topBar.h-40)/2), w: 40, h: 40, onClick: ()=>{ State.mode='add'; State.focusField='hiragana'; hideMobileInput(); } };
    clickZones.push(gear);

    // Barra de progresso e streak no topo (lado direito)
    const progW = Math.min(380, W - pad*2 - 40 - 12);
    const prog = { x: W - pad - progW, y: topBar.y + Math.floor((topBar.h-18)/2), w: progW, h: 16 };

    // Filtros do treino (pills)
    let trainPills=[];
    if(State.mode==='train'){
      const defs=[{key:'todas',label:'Todas'},{key:'dificil',label:'Dif√≠cil'},{key:'medio',label:'M√©dio'},{key:'facil',label:'F√°cil'}];
      const pw = Math.floor((card.w - 24*2 - 10*3)/4); // 4 p√≠lulas
      const ph = SIZES.pillH; let px=card.x+24, py=card.y+16;
      for(const p of defs){
        const pill={x:px,y:py,w:pw,h:ph,label:p.label,active: State.trainFilter===p.key};
        trainPills.push(pill);
        clickZones.push({x:pill.x,y:pill.y,w:pw,h:ph,onClick:()=>{ State.trainFilter=p.key; pickNextTrain(); }});
        px+=pw+10;
      }
    }

    // STUDY & TRAIN (campo de resposta mobilizado)
    if(State.mode==='study'||State.mode==='train'){
      const btnAudio={x:card.x+card.w-48,y:card.y+12,w:36,h:36,label:'\uD83D\uDD0A',fill:'#243b55',onClick:()=>{ if(currentCard) speakJP(currentCard.hiragana); }};
      buttons.push(btnAudio);

      // Caixa de resposta
      const inpW = card.w - 24*2;
      const inpX = card.x + 24;
      const baseY = card.y + Math.max(96, Math.floor(card.h*0.42));
      const inp = { x: inpX, y: baseY, w: inpW, h: 52, label:'Tradu√ß√£o (PT-BR)', value: State.input, placeholder: 'ex.: ol√°; boa tarde', focused: true };
      inputs.push(inp);
      clickZones.push({ x: inp.x, y: inp.y, w: inp.w, h: inp.h, onClick: ()=>{
        showMobileInput(inp.x, inp.y, inp.w, inp.h, State.input, 'ex.: ol√°; boa tarde', { mode:'study' });
      }});

      if(!State.showAnswer){
        const btnVer={x:inp.x+inp.w-160,y:inp.y+inp.h+12,w:160,h:SIZES.buttonH,label:'Verificar',onClick:()=>{ hideMobileInput(); checkAnswer(); }};
        buttons.push(btnVer);
      } else {
        const bx=card.x+24, by=inp.y+inp.h+12; const bw=Math.floor((card.w-24*2-12*2)/3), bh=SIZES.buttonH;
        const bHard={x:bx,y:by,w:bw,h:bh,label:'Dif√≠cil',fill:C.danger,onClick:()=>chooseDifficulty('dificil')};
        const bMed={x:bx+bw+12,y:by,w:bw,h:bh,label:'M√©dio',fill:C.warn,onClick:()=>chooseDifficulty('medio')};
        const bEasy={x:bx+(bw+12)*2,y:by,w:bw,h:bh,label:'F√°cil',fill:C.accent2,onClick:()=>chooseDifficulty('facil')};
        buttons.push(bHard,bMed,bEasy);
      }
    }

    // ADD (form com 3 campos, cada um abre teclado)
    if(State.mode==='add'){
      const iw=Math.min(520,card.w-32); const ix=card.x+(card.w-iw)/2;
      const i1={x:ix,y:card.y+64,w:iw,h:56,label:'Hiragana',value:State.addForm.hiragana,placeholder:'ex.: „Åì„Çì„Å´„Å°„ÅØ',focused:State.focusField==='hiragana'};
      const i2={x:ix,y:card.y+64+66,w:iw,h:56,label:'Romaji',value:State.addForm.romaji,placeholder:'ex.: konnichiwa',focused:State.focusField==='romaji'};
      const i3={x:ix,y:card.y+64+66*2,w:iw,h:56,label:'Tradu√ß√£o (PT-BR)',value:State.addForm.pt,placeholder:'ex.: ol√°; boa tarde',focused:State.focusField==='pt'};
      inputs.push(i1,i2,i3);
      for(const it of [i1,i2,i3]){
        const f = (it===i1?'hiragana':it===i2?'romaji':'pt');
        clickZones.push({x:it.x,y:it.y,w:it.w,h:it.h,onClick:()=>{
          State.focusField=f;
          showMobileInput(it.x, it.y, it.w, it.h, State.addForm[f], it.placeholder, { mode:'add', field:f });
        }});
      }
      const bAdd={x:ix,y:i3.y+i3.h+12,w:iw,h:SIZES.buttonH,label:'Adicionar (Enter)',onClick:()=>{ hideMobileInput(); addCardFromForm(); }};
      const bBulk={x:ix,y:bAdd.y+SIZES.buttonH+12,w:iw,h:SIZES.buttonH,label:'Colar lista (Bulk)',fill:'#334155',onClick:()=>{ State.mode='bulk'; State.bulkText=''; State.message='Cole/edite sua lista aqui.'; showMobileInput(ix, bAdd.y+SIZES.buttonH+12, iw, Math.min(220, card.h-200), State.bulkText, 'hiragana ; romaji ; tradu√ß√£o1 ; ...', {mode:'bulk'}); }};
      buttons.push(bAdd,bBulk);
    }

    // BULK (texto aparece no pr√≥prio overlay-input)
    if(State.mode==='bulk'){
      // Apenas orienta√ß√µes visuais
      // O conte√∫do √© editado no overlay input j√° aberto em bBulk
    }

    // MANAGE (lista)
    if(State.mode==='manage'){
      const listX=card.x+12, listY=card.y+56, listW=card.w-24, rowH=36; 
      const items=sortDeck(deck,State.manage.sort);
      const start=State.manage.page*State.manage.pageSize; 
      const end=Math.min(items.length,start+State.manage.pageSize);
      for(let r=start,row=0;r<end;r++,row++){
        const it=items[r]; const y=listY+row*rowH; 
        if(State.manage.selected===it.id){roundRect(listX,y,listW,rowH-6,10); ctx.fillStyle='rgba(67,182,255,0.12)'; ctx.fill();}
        ctx.fillStyle=C.text; ctx.font='600 14px system-ui'; ctx.textAlign='left'; ctx.textBaseline='middle';
        // Hiragana menor
        const __prev=ctx.font; ctx.font=`700 ${SIZES.hiraganaManagePx}px system-ui`; ctx.fillText(it.hiragana, listX+8, y+rowH/2);
        ctx.font=__prev; ctx.fillStyle=C.sub; ctx.fillText(' ‚Ä¢ '+it.romaji+'  |  '+(it.cat||'none')+'  |  due '+(it.due||'')+'  | ‚úì'+(it.ok||0)+'  ‚úó'+(it.err||0), listX+60, y+rowH/2);
        clickZones.push({x:listX,y:y,w:listW,h:rowH-6,onClick:()=>{State.manage.selected=it.id;}});
      }
      const totalPages=Math.max(1,Math.ceil(deck.length/State.manage.pageSize));
      const bPrev={x:card.x+12,y:card.y+card.h-48,w:120,h:40,label:'‚óÄ Anterior',fill:'#1f2937',onClick:()=>{State.manage.page=Math.max(0,State.manage.page-1);}}; 
      const bNext={x:card.x+12+120+8,y:card.y+card.h-48,w:120,h:40,label:'Pr√≥xima ‚ñ∂',fill:'#1f2937',onClick:()=>{State.manage.page=Math.min(totalPages-1,State.manage.page+1);}}; 
      const bDel={x:card.x+card.w-160-12,y:card.y+card.h-48,w:160,h:40,label:'Excluir',fill:'#dc2626',onClick:deleteSelected}; 
      buttons.push(bPrev,bNext,bDel); 
      ctx.fillStyle=C.sub; ctx.font='600 12px system-ui'; ctx.textAlign='left'; ctx.textBaseline='middle'; ctx.fillText(`P√°gina ${State.manage.page+1}/${totalPages}`, card.x+12, card.y+card.h-58);
    }

    // QUIZ ‚Äî bot√µes
    if (State.mode === 'quiz') {
      const q = State.quiz;
      if (q.current) {
        const gridPad = 10;
        const bw = (card.w - gridPad * 3) / 2;
        const bh = SIZES.buttonH;
        let ox = card.x + gridPad,
            oy = card.y + card.h - (bh * 2 + gridPad * 3);
        for (let i = 0; i < 4; i++) {
          const row = Math.floor(i / 2), col = i % 2;
          const bx = ox + col * (bw + gridPad), by = oy + row * (bh + gridPad);
          const isSel = q.selectedIndex === i; const isCorrect = (q.correctIndex === i);
          let fillVar = '#1f2937'; if (q.selectedIndex !== -1) { if (isCorrect) fillVar = C.accent2; else if (isSel) fillVar = C.danger; }
          buttons.push({ x: bx, y: by, w: bw, h: bh, label: q.options[i] || '‚Äî', fill: fillVar, onClick: () => selectQuizOption(i) });
        }
        buttons.push({ x: card.x + card.w - 140, y: card.y + card.h - SIZES.buttonH, w: 120, h: SIZES.buttonH, label: (q.selectedIndex === -1 ? 'Pular' : 'Pr√≥ximo ‚ñ∂'), fill: '#0ea5e9', onClick: nextQuiz });
        buttons.push({ x: card.x + 12, y: card.y + card.h - SIZES.buttonH, w: 40, h: Math.max(36, SIZES.buttonH - 8), label: 'üîä', fill: '#243b55', onClick: () => { speakJP(q.current.hiragana); } });
      }
    }

    return { topBar, bottomBar, buttons, clickZones, card, inputs, gear, prog, pad, cardW, cardH };
  }

  // -----------------------
  //  RENDER
  // -----------------------
  let _tick=0; function tick(){return _tick;}
  function render(){
    _tick++;
    const L = layout();
    ctx.clearRect(0,0,cvs.clientWidth,cvs.clientHeight);

    // Top bar
    ctx.fillStyle = '#0b0f14'; ctx.fillRect(0,0,cvs.clientWidth,SIZES.headerH);
    drawIconButton({x:L.gear.x,y:L.gear.y,w:L.gear.w || 40,h:L.gear.h || 40},'‚öô');
    const pct=Math.max(0,Math.min(1,(stats.studiedToday||0)/(stats.dailyGoal||20))); 
    drawProgressBar(L.prog.x, L.prog.y, L.prog.w, L.prog.h, pct);

    // Card
    roundRect(L.card.x, L.card.y, L.card.w, L.card.h, 20); ctx.fillStyle=C.card; ctx.fill(); ctx.strokeStyle=C.stroke; ctx.stroke();

    // Conte√∫do por modo
    if(State.mode==='study'||State.mode==='train'){
      // T√≠tulos
      ctx.fillStyle=C.text; ctx.font='800 18px system-ui'; ctx.textAlign='left'; ctx.textBaseline='top';
      ctx.fillText(State.mode==='study'?'Estudar':'Treinar', L.card.x+24, L.card.y+16);
      // Treino: filtros
      if(State.mode==='train'){
        const L2 = layout(); // para pegar pills
        if(L2 && L2.buttons){} // noop
      }

      if(!currentCard){
        ctx.fillStyle=C.sub; ctx.font='600 16px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
        const msg = (State.mode==='study')?'Nenhum card devido. V√° ao Quiz/Treino ou volte depois.':(trainPool().length? 'Digite a tradu√ß√£o e toque em Verificar.':'Sem itens nesta categoria. Troque o filtro.');
        ctx.fillText(msg, L.card.x+L.card.w/2, L.card.y+L.card.h/2);
      } else {
        // HIRAGANA (menor no mobile)
        ctx.fillStyle=C.text; 
        ctx.font = `800 ${Math.max(SIZES.hiraganaStudyMin, Math.floor(L.card.h * SIZES.hiraganaStudyFactor))}px system-ui`;
        ctx.textAlign='center'; ctx.textBaseline='top'; 
        ctx.fillText(currentCard.hiragana, L.card.x+L.card.w/2, L.card.y+44); 

        // Romaji
        ctx.fillStyle=C.sub; ctx.font='700 20px system-ui';
        const ry = L.card.y + 44 + Math.max(SIZES.hiraganaStudyMin, Math.floor(L.card.h*SIZES.hiraganaStudyFactor)) + 6;
        ctx.fillText(currentCard.romaji, L.card.x+L.card.w/2, ry);

        // Resposta correta (ap√≥s verificar)
        let afterY = ry + 34;
        if(State.showAnswer){
          const answers=parseAnswers(currentCard.pt);
          ctx.fillStyle=C.sub; ctx.font='700 14px system-ui'; ctx.fillText('Respostas aceitas:', L.card.x+L.card.w/2, afterY);
          ctx.fillStyle=C.text; ctx.font='900 20px system-ui'; ctx.fillText(answers.join(' / '), L.card.x+L.card.w/2, afterY+20);
          afterY += 56;
        }

        // Bot√£o √°udio
        drawButton({x:L.card.x+L.card.w-48,y:L.card.y+12,w:36,h:36,label:'üîä',fill:'#243b55',onClick:()=>{ if(currentCard) speakJP(currentCard.hiragana); }});

        // Filtros Treino
        if(State.mode==='train'){
          const defs=[{key:'todas',label:'Todas'},{key:'dificil',label:'Dif√≠cil'},{key:'medio',label:'M√©dio'},{key:'facil',label:'F√°cil'}];
          const pw = Math.floor((L.card.w - 24*2 - 10*3)/4), ph=SIZES.pillH; let px=L.card.x+24, py=L.card.y+16;
          for(const p of defs){ const pill={x:px,y:py,w:pw,h:ph,label:p.label,active: State.trainFilter===p.key}; drawPill(pill); const hitz={x:px,y:py,w:pw,h:ph,onClick:()=>{ State.trainFilter=p.key; pickNextTrain(); }}; if(!layout().clickZones.some(z=>z===hitz)){} px+=pw+10; }
        }

        // Campo de input (desenhado e com overlay real ao toque)
        const inpW = L.card.w - 24*2; const inpX = L.card.x + 24; const baseY = L.card.y + Math.max(96, Math.floor(L.card.h*0.42));
        drawInputBox({ x: inpX, y: baseY, w: inpW, h: 52, label:'Tradu√ß√£o (PT-BR)', value: State.input, placeholder:'ex.: ol√°; boa tarde', focused:true });

        if(!State.showAnswer){ drawButton({x:inpX+inpW-160,y:baseY+52+12,w:160,h:SIZES.buttonH,label:'Verificar',onClick:()=>{ hideMobileInput(); checkAnswer(); }}); }
        else {
          const bx= L.card.x+24, by=baseY+52+12; const bw=Math.floor((L.card.w-24*2-12*2)/3), bh=SIZES.buttonH;
          drawButton({x:bx,y:by,w:bw,h:bh,label:'Dif√≠cil',fill:C.danger,onClick:()=>chooseDifficulty('dificil')});
          drawButton({x:bx+bw+12,y:by,w:bw,h:bh,label:'M√©dio',fill:C.warn,onClick:()=>chooseDifficulty('medio')});
          drawButton({x:bx+(bw+12)*2,y:by,w:bw,h:bh,label:'F√°cil',fill:C.accent2,onClick:()=>chooseDifficulty('facil')});
        }
      }
    }

    if(State.mode==='add'){
      ctx.fillStyle=C.text; ctx.font='800 18px system-ui'; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillText('Adicionar novo card', L.card.x+L.card.w/2, L.card.y+16);
      const iw=Math.min(520, L.card.w-32); const ix=L.card.x+(L.card.w-iw)/2;
      const i1={x:ix,y:L.card.y+64,w:iw,h:56,label:'Hiragana',value:State.addForm.hiragana,placeholder:'ex.: „Åì„Çì„Å´„Å°„ÅØ',focused:State.focusField==='hiragana'}; 
      const i2={x:ix,y:L.card.y+64+66,w:iw,h:56,label:'Romaji',value:State.addForm.romaji,placeholder:'ex.: konnichiwa',focused:State.focusField==='romaji'}; 
      const i3={x:ix,y:L.card.y+64+66*2,w:iw,h:56,label:'Tradu√ß√£o (PT-BR)',value:State.addForm.pt,placeholder:'ex.: ol√°; boa tarde',focused:State.focusField==='pt'}; 
      for(const i of [i1,i2,i3]) drawInputBox(i);
      drawButton({x:ix,y:i3.y+i3.h+12,w:iw,h:SIZES.buttonH,label:'Adicionar (Enter)',onClick:()=>{ hideMobileInput(); addCardFromForm(); }});
      drawButton({x:ix,y:i3.y+i3.h+12+SIZES.buttonH+12,w:iw,h:SIZES.buttonH,label:'Colar lista (Bulk)',fill:'#334155',onClick:()=>{ State.mode='bulk'; State.bulkText=''; State.message='Cole/edite sua lista.'; showMobileInput(ix, i3.y+i3.h+12+SIZES.buttonH+12, iw, Math.min(220, L.card.h-200), State.bulkText, 'hiragana ; romaji ; tradu√ß√£o1 ; ...', {mode:'bulk'}); }});
    }

    if(State.mode==='summary'){
      ctx.fillStyle=C.text; ctx.font='800 18px system-ui'; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillText('Resumo do dia', L.card.x+L.card.w/2, L.card.y+16);
      ctx.textAlign='left'; ctx.font='700 16px system-ui'; ctx.fillStyle=C.sub; 
      const Ls=[`Cards estudados hoje: ${stats.studiedToday||0}`,`Meta di√°ria: ${stats.dailyGoal||20}`,`Streak atual: ${stats.streak||0} dia(s)`,`Cards no deck: ${deck.length}`,`Cards devidos agora: ${dueCards().length}`]; 
      let yy=L.card.y+64; for(const t of Ls){ctx.fillText(t,L.card.x+24,yy); yy+=28;}
    }

    if(State.mode==='quiz'){
      const q=State.quiz;
      ctx.fillStyle=C.text; ctx.font='800 18px system-ui'; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillText('Quiz ‚Äî toque na tradu√ß√£o correta', L.card.x+L.card.w/2, L.card.y+16);
      if(!q.current){
        ctx.fillStyle=C.sub; ctx.font='600 16px system-ui'; ctx.fillText('Sem cartas suficientes. Adicione ‚öô e volte ao Quiz.', L.card.x+L.card.w/2, L.card.y+L.card.h/2);
      } else {
        const romajiSize = Math.max(28, Math.floor(L.card.h * 0.16));
        const romajiY = L.card.y + 56;
        ctx.fillStyle = C.text; ctx.font = `900 ${romajiSize}px system-ui`; ctx.fillText(q.current.romaji, L.card.x + L.card.w/2, romajiY);
        const hiraganaY = romajiY + 10 + 22; // pequeno espa√ßamento
        ctx.fillStyle = C.sub; ctx.font = `700 ${SIZES.hiraganaQuizPx}px system-ui`; ctx.fillText(q.current.hiragana, L.card.x + L.card.w/2, hiraganaY);
      }
    }

    // Mensagens (toast)
    if(State.message){
      ctx.fillStyle='rgba(0,0,0,0.55)'; 
      const mw=Math.min(640,cvs.clientWidth-24); 
      const mx=(cvs.clientWidth-mw)/2, my=cvs.clientHeight - SIZES.footerH - 20; 
      roundRect(mx,my,mw,40,12); ctx.fill(); ctx.strokeStyle='rgba(255,255,255,0.2)'; ctx.stroke(); 
      ctx.fillStyle=C.text; ctx.font='700 14px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(State.message, mx+mw/2, my+20);
    }

    // Footer tabs
    ctx.fillStyle = '#0b0f14'; ctx.fillRect(0, cvs.clientHeight - SIZES.footerH, cvs.clientWidth, SIZES.footerH);
    const L2 = layout(); for(const b of L2.buttons) drawButton(b);

    requestAnimationFrame(render);
  }
  render();

  // ------------
  // Fun√ß√µes deck
  // ------------
  function addCardFromForm(){
    const f=State.addForm; 
    if(!f.hiragana.trim()||!f.romaji.trim()||!f.pt.trim()){State.message='Preencha todos os campos';return;} 
    const combo=`${f.hiragana.trim()}|${f.romaji.trim().toLowerCase()}`; 
    const dup=deck.some(c=>`${(c.hiragana||'').trim()}|${(c.romaji||'').toLowerCase().trim()}`===combo); 
    if(dup){State.message='J√° existe um card com esse Hiragana+Romaji';return;} 
    const id=String(Date.now()); 
    const ptStore=f.pt.trim().toLowerCase().replace(/\s*([;|,])\s*/g,'|'); 
    deck.push({id:id,hiragana:f.hiragana.trim(),romaji:f.romaji.trim().toLowerCase(),pt:ptStore,due:todayStr(),ef:2.5,ivl:0,reps:0,ok:0,err:0,cat:'none'}); 
    saveDeck(); 
    State.addForm={hiragana:'',romaji:'',pt:''}; 
    State.focusField='hiragana'; 
    State.message='Card adicionado!';
  }
  function deleteSelected(){const id=State.manage.selected; if(!id){State.message='Selecione um item';return;} deck=deck.filter(c=>c.id!==id); saveDeck(); State.manage.selected=null; State.message='Card removido.';}
  function sortDeck(items,key){const a=items.slice(); a.sort((x,y)=>{if(key==='due'){return (x.due||'')<(y.due||'')?-1:1;} if(key==='ok'){return (y.ok||0)-(x.ok||0);} if(key==='err'){return (y.err||0)-(x.err||0);} if(key==='cat'){return (x.cat||'').localeCompare(y.cat||'');} return x.hiragana.localeCompare(y.hiragana);}); return a;}

  // -----------------
  // Verifica√ß√£o/respo
  // -----------------
  function checkAnswer(){
    if(!currentCard) return; 
    const ok=parseAnswers(currentCard.pt).includes(normalizeBasic(State.input)); 
    State.showAnswer=true; 
    State.message= ok?'‚úî Correto! Escolha a dificuldade.':'‚úò Quase! Veja as respostas e marque a dificuldade.';
  }
  function chooseDifficulty(level){
    if(!currentCard) return;
    currentCard.cat = level; saveDeck();
    if(State.mode==='study'){
      const g = (level==='dificil')?0:(level==='medio')?1:2;
      const ok = parseAnswers(currentCard.pt).includes(normalizeBasic(State.input));
      if(ok) currentCard.ok=(currentCard.ok||0)+1; else currentCard.err=(currentCard.err||0)+1;
      schedule(currentCard,g); saveDeck();
      stats.studiedToday=(stats.studiedToday||0)+1; stats.lastStudy=todayStr(); if(!stats.streak)stats.streak=1; saveStats();
      pickNext(); hideMobileInput();
    } else { pickNextTrain(); hideMobileInput(); }
  }

  // ---------------
  // Atalhos m√≠nimos
  // ---------------
  window.addEventListener('keydown',e=>{
    if((State.mode==='study'||State.mode==='train'||State.mode==='quiz')&&(e.key==='F5'||(e.ctrlKey&&e.key.toLowerCase()==='r'))){e.preventDefault();return;}
    if(!IS_MOBILE){
      if(State.mode==='study'||State.mode==='train'){
        if(!State.showAnswer){ if(e.key==='Enter'){ checkAnswer(); return; } if(e.key==='Backspace'){ State.input = State.input.slice(0,-1); return; } if(e.key.length===1){ State.input += e.key; return; } }
        else { if(e.key==='1'){chooseDifficulty('dificil');return;} if(e.key==='2'){chooseDifficulty('medio');return;} if(e.key==='3'){chooseDifficulty('facil');return;} }
      }
      if(State.mode==='add'){
        const f=State.focusField||'hiragana';
        if(e.key==='Enter'){ addCardFromForm(); return; }
        if(e.key==='Backspace'){ State.addForm[f] = State.addForm[f].slice(0,-1); return; }
        if(e.key.length===1){ State.addForm[f] += e.key; return; }
      }
    }
  });

  // Inicializa
  pickNext();

  </script>
</body>
</html>
